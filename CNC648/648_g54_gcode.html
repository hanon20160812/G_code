

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G-code ç”¢ç”Ÿå™¨ - å°æ¥ç‰ˆæœ¬ (G54)</title>
  <style>
    :root {
      --background-color: #1e1e2e;
      --card-color: #2a2a3c;
      --primary-color: #74c7ec;
      --secondary-color: #cdd6f4;
      --accent-color: #89b4fa;
      --text-color: #cdd6f4;
      --muted-color: #a6adc8;
      --border-color: #45475a;
      --success-color: #a6e3a1;
      --warning-color: #f9e2af;
      --danger-color: #f38ba8;
      --font-size-base: 16px;
      --font-size-large: 18px;
      --font-size-title: 24px;
      --line-height: 1.5;
    }
    
    body { 
      font-family: 'Noto Sans TC', 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; 
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      max-width: 1500px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: var(--font-size-base);
      line-height: var(--line-height);
    }
    
    .header {
      padding: 25px;
      text-align: center;
      position: relative;
    }
    
    h2 {
      color: var(--accent-color);
      margin: 0;
      font-size: var(--font-size-title);
      font-weight: 600;
    }
    
    h3 {
      color: var(--primary-color);
      font-size: var(--font-size-large);
      margin-top: 0;
      margin-bottom: 20px;
      letter-spacing: 0.5px;
      font-weight: 500;
      display: flex;
      align-items: center;
    }
    
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
      padding: 15px 25px 35px;
      flex: 1;
    }
    
    @media (min-width: 1200px) {
      .container {
        grid-template-columns: 320px 370px 1fr;
      }
    }
    
    .column {
      background: var(--card-color);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 25px;
      border: 1px solid var(--border-color);
      transition: transform 0.3s, box-shadow 0.3s;
      min-height: calc(100vh - 150px);
      display: flex;
      flex-direction: column;
    }
    
    .column:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    
    .column-header {
      display: flex;
      align-items: center;
      margin-bottom: 22px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }
    
    .step-number {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 30px;
      height: 30px;
      background-color: var(--primary-color);
      color: var(--background-color);
      border-radius: 50%;
      font-size: 16px;
      font-weight: bold;
      margin-right: 12px;
    }
    
    .left-column .step-number {
      background-color: var(--primary-color);
    }
    
    .middle-column .step-number {
      background-color: var(--success-color);
    }
    
    .right-column .step-number {
      background-color: var(--warning-color);
    }
    
    label {
      font-weight: 400;
      display: block;
      margin-top: 15px;
      margin-bottom: 8px;
      color: var(--text-color);
      font-size: var(--font-size-base);
    }
    
    input, textarea, button {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-family: inherit;
      box-sizing: border-box;
      font-size: var(--font-size-base);
      background-color: #313244;
      color: var(--text-color);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(137, 180, 250, 0.2);
    }
    
    textarea {
      min-height: 150px;
      resize: vertical;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: calc(var(--font-size-base) - 1px);
      line-height: 1.5;
      flex-grow: 1;
      margin-bottom: 15px;
    }
    
    button {
      background-color: var(--accent-color);
      color: #1e1e2e;
      border: none;
      padding: 12px;
      margin-top: 18px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      border-radius: 8px;
      font-size: var(--font-size-base);
    }
    
    button:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }
    
    .generate-button {
      background-color: var(--success-color);
      font-size: var(--font-size-large);
      padding: 14px;
    }
    
    .generate-button:hover {
      background-color: #94e2a5;
    }
    
    .fill-button {
      background-color: var(--warning-color);
      color: #1e1e2e;
    }
    
    .fill-button:hover {
      background-color: #f8e3b4;
    }
    
    .import-button {
      background-color: var(--primary-color);
      color: #1e1e2e;
    }
    
    .import-button:hover {
      background-color: #8dd3f2;
    }
    
    .extra-settings {
      background-color: rgba(255, 255, 255, 0.05);
      padding: 16px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 3px solid var(--accent-color);
    }
    
    .coordinate-input {
      margin-bottom: 15px;
    }
    
    .angle-input {
      display: flex;
      gap: 15px;
    }
    
    .angle-input > div {
      flex: 1;
    }
    
    #output {
      height: 370px;
      background-color: #313244;
      font-size: calc(var(--font-size-base) - 1px);
      flex-grow: 2;
    }
    
    #angleGcodeOutput {
      height: 170px;
    }
    
    .checkboxContainer {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .checkboxContainer input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
      accent-color: var(--primary-color);
    }
    
    .section-title {
      font-size: var(--font-size-base);
      font-weight: 500;
      color: var(--primary-color);
      margin-bottom: 12px;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 18px;
    }
    
    .action-buttons button {
      margin-top: 0;
      flex: 1;
    }
    
    .copy-button {
      background-color: var(--accent-color);
    }
    
    .download-button {
      background-color: var(--muted-color);
    }
    
    .clear-button {
      background-color: var(--danger-color);
      color: #1e1e2e;
    }
    
    ::placeholder {
      color: var(--muted-color);
      opacity: 0.6;
    }
    
    .mirror-notice {
      background: rgba(255, 165, 0, 0.1);
      border: 1px solid #f9e2af;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      color: var(--warning-color);
      margin-bottom: 15px;
    }
    
    .import-section {
      background: rgba(116, 199, 236, 0.1);
      border: 1px solid var(--primary-color);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .status-message {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-size: 14px;
      display: none;
    }
    
    .status-success {
      background: rgba(166, 227, 161, 0.2);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }
    
    .status-error {
      background: rgba(243, 139, 168, 0.2);
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
    }
    
    .status-warning {
      background: rgba(249, 226, 175, 0.2);
      color: var(--warning-color);
      border: 1px solid var(--warning-color);
    }
    
    .data-preview {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      margin-top: 10px;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .auto-import-notice {
      background: rgba(166, 227, 161, 0.1);
      border: 1px solid var(--success-color);
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      color: var(--success-color);
      margin-bottom: 15px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .debug-panel {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid #ff6b6b;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
      font-size: 12px;
      font-family: monospace;
      max-height: 150px;
      overflow-y: auto;
    }


    .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .btn-link {
            background: var(--muted-color);
            color: var(--background-color);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .btn-link:hover {
            background: var(--primary-color);
            transform: translateY(-1px);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            flex: 1;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: var(--accent-color);
            color: var(--background-color);
        }
        
        .btn-success {
            background: var(--success-color);
            color: var(--background-color);
        }
        
        .btn-import {
            background: var(--primary-color);
            color: var(--background-color);
        }

  </style>
</head>
<body>

<div class="header">
  <h2>G-code ç”¢ç”Ÿå™¨ - å°æ¥ç‰ˆæœ¬ (G54)</h2>
  <button id="clearAllButton" class="clear-button" style="position: absolute; right: 20px; top: 20px; width: auto; padding: 8px 15px;">ä¸€éµæ¸…é™¤</button>
</div>

<div class="container">
  <!-- å·¦å´æ¬„ - åº§æ¨™è¨­å®š -->
  <div class="column left-column">
    <div class="column-header">
      <div class="step-number">1</div>
      <h3>åº§æ¨™è¨­å®š</h3>
    </div>
    
    <!-- è‡ªå‹•å°å…¥æç¤º -->
    <div id="autoImportNotice" class="auto-import-notice" style="display: none;">
      ğŸ”„ åµæ¸¬åˆ°ä¾†è‡ªCNCè¨ˆç®—å™¨çš„æ•¸æ“šï¼Œæ­£åœ¨è‡ªå‹•å°å…¥...
    </div>
    
    <!-- é™¤éŒ¯è³‡è¨Šé¢æ¿ -->
    <div id="debugPanel" class="debug-panel" style="display: none;">
      <strong>é™¤éŒ¯è³‡è¨Šï¼š</strong><br>
      <div id="debugContent"></div>
    </div>
    
    <div class="mirror-notice">
      âš ï¸ å³å´ç‰ˆæœ¬ - ä½¿ç”¨G54åº§æ¨™ç³»çµ±
    </div>
    <div class="import-section">
      <div class="section-title">ğŸ”— å¾CNCè¨ˆç®—å™¨å°å…¥</div>
      <button class="import-button" onclick="importFromCalculator()">ğŸ“¥ æ‰‹å‹•å°å…¥æ•¸æ“š</button>
      <div id="importStatus" class="status-message"></div>
      <div id="importPreview" class="data-preview" style="display: none;"></div>
    </div>   
    
    <div class="coordinate-input">
      <label>å“å:</label>
      <input id="productName" value="" placeholder="å¦‚: 31F-07">
    </div>
    
    <div class="coordinate-input">
      <label><span style="color: #f9e2af; font-weight: bold;">A åº§æ¨™:</span></label>
      <input id="coordA" value="" placeholder="å¦‚: X-100 Y100" style="border-color: #f9e2af;">
    </div>
    
    <div class="coordinate-input">
      <label><span style="color: #f9e2af; font-weight: bold;">B åº§æ¨™:</span></label>
      <input id="coordB" value="" placeholder="å¦‚: X-100 Y100" style="border-color: #f9e2af;">
    </div>
    
    <div class="coordinate-input">
      <label><span style="color: #a6e3a1; font-weight: bold;">C åº§æ¨™:</span></label>
      <input id="coordC" value="" placeholder="å¦‚: X-100 Y100" style="border-color: #a6e3a1;">
    </div>
    
    <div class="coordinate-input">
      <label><span style="color: #6abf69; font-weight: bold;">D åº§æ¨™:</span></label>
      <input id="coordD" value="" placeholder="å¦‚: X-100 Y100" style="border-color: #488e46;">
    </div>
    
    <div style="flex-grow: 1;"></div>
    
    <div class="settings-summary" style="margin-top: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: auto;">
      <div class="section-title">åº§æ¨™è¨­å®šèªªæ˜</div>
      <ul style="color: var(--muted-color); padding-left: 20px; font-size: 0.85rem; margin: 10px 0;">
        <li>Aåº§æ¨™ç”¨æ–¼ç¬¬ä¸€æ®µåŠ å·¥ä½ç½® (A2èµ·é»)</li>
        <li>Båº§æ¨™ç”¨æ–¼ç¬¬äºŒæ®µåŠ å·¥ä½ç½® (B2èµ·é»)</li>
        <li>Cåº§æ¨™ç”¨æ–¼ç¬¬ä¸‰æ®µåˆ‡å‰Šèµ·é»</li>
        <li>Dåº§æ¨™ç”¨æ–¼ç¬¬ä¸‰æ®µåˆ‡å‰Šçµ‚é»</li>
        <li style="color: #f9e2af;">â€» å¯è‡ªå‹•å¾CNCè¨ˆç®—å™¨å°å…¥</li>
        <li style="color: #74c7ec;">â€» Xåº§æ¨™å·²é¡åƒ (ä»¥Yè»¸ç‚ºä¸­å¿ƒç·š)</li>
      </ul>
    </div>
  </div>
  
  <!-- ä¸­é–“æ¬„ - è§’åº¦è¨ˆç®—å™¨ -->
  <div class="column middle-column">
    <div class="column-header">
      <div class="step-number">2</div>
      <h3>è§’åº¦è¨ˆç®—å™¨</h3>
    </div>
    
    <div class="angle-input">
      <div>
        <label>è§’åº¦ (åº¦):</label>
        <input type="number" id="angle" value="45" step="0.1" oninput="angleChanged()">
      </div>
      
      <div>
        <label>ç›´å¾‘ (MM):</label>
        <input type="number" id="diameter" value="18" step="0.1" oninput="angleChanged()">
      </div>
    </div>
    
    <div class="extra-settings">
      <div class="section-title">åˆå§‹ç§»å‹•è¨­å®š</div>
      <div class="checkboxContainer">
        <input type="checkbox" id="addInitialMove" checked oninput="angleChanged()">
        <label for="addInitialMove" style="display: inline; margin: 0;">æ·»åŠ åˆå§‹ç§»å‹•</label>
      </div>
      <input type="text" id="initialMove" value="G1G91X-60.000 F200" placeholder="è¼¸å…¥åˆå§‹ç§»å‹• G-CODE" oninput="angleChanged()">
    </div>
    
    <label>è§’åº¦ G-CODE çµæœ:</label>
    <textarea id="angleGcodeOutput" readonly></textarea>
    
    <button class="generate-button" onclick="generate()">ç”¢ç”Ÿå®Œæ•´ G-code</button>
  </div>
  
  <!-- å³å´æ¬„ - å®Œæ•´G-codeç”Ÿæˆ -->
  <div class="column right-column">
    <div class="column-header">
      <div class="step-number">3</div>
      <h3>å®Œæ•´ G-code ç”Ÿæˆ</h3>
    </div>
    
    <div class="action-buttons">
      <a href="https://ncviewer.com/" target="_blank" class="btn btn-link btn-small" title="åœ¨ NC Viewer ä¸­æŸ¥çœ‹ G-CODE">
        ğŸ” CNCæª¢æŸ¥
    </a>
      <button class="copy-button" onclick="copyToClipboard()">è¤‡è£½ G-code</button>
      <button class="download-button" onclick="downloadGcode()">ä¸‹è¼‰ G-code</button>
    </div>
    
    <label>ç”¢ç”Ÿçš„ G-code:</label>
    <textarea id="output"></textarea>
  </div>
</div>

<script>
// å…¨åŸŸé™¤éŒ¯è®Šæ•¸
let debugMode = false;
const debugLog = [];

function addDebugLog(message) {
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = `[${timestamp}] ${message}`;
  debugLog.push(logEntry);
  console.log(logEntry);
}

function updateDebugPanel() {
  const debugContent = document.getElementById('debugContent');
  if (debugContent) {
    debugContent.innerHTML = debugLog.slice(-10).join('<br>'); // é¡¯ç¤ºæœ€è¿‘10æ¢è¨˜éŒ„
  }
}

function toFixed3(n) {
  return parseFloat(n).toFixed(3);
}

function angleChanged() {
  addDebugLog('è§’åº¦è®ŠåŒ–ï¼Œé‡æ–°è¨ˆç®—G-CODE');
  generateAngleGCode();
}

function generateAngleGCode() {
  try {
    const angleDeg = parseFloat(document.getElementById('angle').value) || 45;
    const diameter = parseFloat(document.getElementById('diameter').value) || 18;
    const radius = diameter / 2;
    const angleRad = angleDeg * Math.PI / 180;

    addDebugLog(`è¨ˆç®—è§’åº¦G-CODE: è§’åº¦=${angleDeg}Â°, ç›´å¾‘=${diameter}mm`);

    // å³å´é¡åƒï¼šXåº§æ¨™åå‘ (ä»¥Yè»¸ç‚ºé¡åƒè»¸ç·š)
    const dx1 = -(radius * Math.cos(angleRad));  // Xåº§æ¨™é¡åƒ
    const dy1 = radius * Math.sin(angleRad);     // Yåº§æ¨™ä¿æŒä¸è®Š
    const dx2 = -2 * dx1;  // ç¬¬äºŒæ®µç§»å‹•ä¹Ÿè¦é¡åƒ
    const dy2 = -2 * dy1;  // Yæ–¹å‘ä¿æŒåŸé‚è¼¯

    const comment = `(ANGLE ${toFixed3(angleDeg)})`;
    const line1 = `G1G91X${toFixed3(dx1)} Y${toFixed3(-dy1)} F200`;
    const line2 = `G1G91X${toFixed3(dx2)} Y${toFixed3(-dy2)} F200`;
    
    let gcode = '';
    
    // æ·»åŠ åˆå§‹ç§»å‹•ï¼ˆå¦‚æœé¸ä¸­ï¼‰
    if (document.getElementById('addInitialMove').checked) {
      const initialMove = document.getElementById('initialMove').value || 'G1G91X-60.000 F200';
      gcode = comment + '\n' + initialMove + '\n' + line1 + '\n' + line2;
    } else {
      gcode = comment + '\n' + line1 + '\n' + line2;
    }

    document.getElementById('angleGcodeOutput').value = gcode;
    addDebugLog('è§’åº¦G-CODEç”Ÿæˆå®Œæˆ');
  } catch (error) {
    addDebugLog(`è§’åº¦G-CODEç”ŸæˆéŒ¯èª¤: ${error.message}`);
  }
}

// åº§æ¨™æ ¼å¼åŒ–å‡½æ•¸
function formatCoordinate(coord) {
  if (!coord) return '';
  
  coord = coord.toString().trim();
  addDebugLog(`æ ¼å¼åŒ–åº§æ¨™: ${coord}`);
  
  // å¦‚æœå·²ç¶“æ˜¯æ­£ç¢ºæ ¼å¼ï¼Œç›´æ¥è¿”å›
  if (/^X-?\d+\.?\d*\s+Y-?\d+\.?\d*$/.test(coord)) {
    return coord;
  }
  
  // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æå–Xå’ŒYåº§æ¨™
  const xMatch = coord.match(/X(-?\d+\.?\d*)/);
  const yMatch = coord.match(/Y(-?\d+\.?\d*)/);
  
  if (xMatch && yMatch) {
    const formatted = `X${xMatch[1]} Y${yMatch[1]}`;
    addDebugLog(`åº§æ¨™æ ¼å¼åŒ–çµæœ: ${formatted}`);
    return formatted;
  }
  
  addDebugLog(`åº§æ¨™æ ¼å¼åŒ–å¤±æ•—ï¼Œè¿”å›åŸå§‹å€¼: ${coord}`);
  return coord;
}

function importFromCalculator() {
  try {
    addDebugLog('é–‹å§‹å°å…¥CNCè¨ˆç®—å™¨æ•¸æ“š...');
    
    // æª¢æŸ¥localStorage
    const storedData = localStorage.getItem('cncCalculatorData');
    addDebugLog(`localStorageæ•¸æ“š: ${storedData ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
    
    if (!storedData) {
      showImportStatus('error', 'âŒ æœªæ‰¾åˆ°CNCè¨ˆç®—å™¨æ•¸æ“šï¼è«‹å…ˆåœ¨CNCè¨ˆç®—å™¨ä¸­è¨ˆç®—ä¸¦å°å‡ºæ•¸æ“šã€‚');
      addDebugLog('æœªæ‰¾åˆ°å„²å­˜æ•¸æ“š');
      return false;
    }
    
    // è§£æJSONæ•¸æ“š
    let data;
    try {
      data = JSON.parse(storedData);
      addDebugLog(`è§£ææ•¸æ“šæˆåŠŸ: ${JSON.stringify(data)}`);
    } catch (parseError) {
      addDebugLog(`JSONè§£æéŒ¯èª¤: ${parseError.message}`);
      showImportStatus('error', 'âŒ æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼å„²å­˜çš„æ•¸æ“šç„¡æ³•è§£æã€‚');
      return false;
    }
    
    // é©—è­‰æ•¸æ“šå®Œæ•´æ€§
    const hasData = data.productName || data.coordA || data.coordB || data.coordC || data.coordD;
    if (!hasData) {
      addDebugLog('æ•¸æ“šé©—è­‰å¤±æ•—ï¼šæ‰€æœ‰æ¬„ä½éƒ½ç‚ºç©º');
      showImportStatus('error', 'âŒ æ•¸æ“šä¸å®Œæ•´ï¼è«‹ç¢ºèªCNCè¨ˆç®—å™¨å·²æ­£ç¢ºå°å‡ºæ•¸æ“šã€‚');
      return false;
    }
    
    // å¡«å…¥æ•¸æ“šåˆ°è¡¨å–®
    if (data.productName) {
      document.getElementById('productName').value = data.productName;
      addDebugLog(`å¡«å…¥ç”¢å“åç¨±: ${data.productName}`);
    }
    
    if (data.coordA) {
      const formattedA = formatCoordinate(data.coordA);
      document.getElementById('coordA').value = formattedA;
      addDebugLog(`å¡«å…¥Aåº§æ¨™: ${formattedA}`);
    }
    
    if (data.coordB) {
      const formattedB = formatCoordinate(data.coordB);
      document.getElementById('coordB').value = formattedB;
      addDebugLog(`å¡«å…¥Båº§æ¨™: ${formattedB}`);
    }
    
    if (data.coordC) {
      const formattedC = formatCoordinate(data.coordC);
      document.getElementById('coordC').value = formattedC;
      addDebugLog(`å¡«å…¥Cåº§æ¨™: ${formattedC}`);
    }
    
    if (data.coordD) {
      const formattedD = formatCoordinate(data.coordD);
      document.getElementById('coordD').value = formattedD;
      addDebugLog(`å¡«å…¥Dåº§æ¨™: ${formattedD}`);
    }
    
    // å¦‚æœæœ‰è§’åº¦æ•¸æ“šï¼Œä¹ŸåŒæ­¥æ›´æ–°
    if (data.angle && !isNaN(parseFloat(data.angle))) {
      document.getElementById('angle').value = data.angle;
      addDebugLog(`å¡«å…¥è§’åº¦: ${data.angle}`);
      angleChanged(); // é‡æ–°è¨ˆç®—è§’åº¦G-CODE
    }
    
    // é¡¯ç¤ºå°å…¥çš„æ•¸æ“šé è¦½
    const previewDiv = document.getElementById('importPreview');
    previewDiv.innerHTML = `
ç”¢å“åç¨±: ${data.productName || 'æœªè¨­å®š'}
è§’åº¦: ${data.angle || 'æœªè¨­å®š'}Â°
Aåº§æ¨™: ${formatCoordinate(data.coordA) || 'æœªè¨­å®š'}
Båº§æ¨™: ${formatCoordinate(data.coordB) || 'æœªè¨­å®š'}
Cåº§æ¨™: ${formatCoordinate(data.coordC) || 'æœªè¨­å®š'}
Dåº§æ¨™: ${formatCoordinate(data.coordD) || 'æœªè¨­å®š'}
å‚™è¨»: A=A2èµ·é», B=B2èµ·é», C=æ–œåˆ‡èµ·é», D=æ–œåˆ‡çµ‚é»
    `;
    previewDiv.style.display = 'block';
    
    showImportStatus('success', 'âœ… æ•¸æ“šå°å…¥æˆåŠŸï¼å·²è‡ªå‹•å¡«å…¥æ‰€æœ‰åº§æ¨™ã€‚');
    addDebugLog('æ•¸æ“šå°å…¥æˆåŠŸ');
    
    // çŸ­æš«å»¶é²å¾Œè‡ªå‹•ç”ŸæˆG-CODE
    setTimeout(() => {
      addDebugLog('é–‹å§‹è‡ªå‹•ç”ŸæˆG-CODE...');
      generate();
    }, 1000);
    
    return true;
    
  } catch (error) {
    addDebugLog(`å°å…¥éç¨‹éŒ¯èª¤: ${error.message}`);
    showImportStatus('error', 'âŒ å°å…¥éç¨‹ä¸­ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹é‡è©¦æˆ–æ‰‹å‹•è¼¸å…¥æ•¸æ“šã€‚');
    return false;
  }
}

function autoImportOnLoad() {
  addDebugLog('æª¢æŸ¥è‡ªå‹•å°å…¥æ¢ä»¶...');
  
  // æª¢æŸ¥URLåƒæ•¸
  const urlParams = new URLSearchParams(window.location.search);
  const fromCalculator = urlParams.get('from') === 'calculator';
  const shouldAutoImport = urlParams.get('autoImport') === 'true';
  
  addDebugLog(`URLåƒæ•¸ - from: ${urlParams.get('from')}, autoImport: ${urlParams.get('autoImport')}`);
  
  // æª¢æŸ¥localStorageä¸­çš„è‡ªå‹•å°å…¥æ¨™è¨˜
  const autoImportFlag = localStorage.getItem('autoImportFlag');
  const autoImportTimestamp = localStorage.getItem('autoImportTimestamp');
  const forceAutoImport = localStorage.getItem('forceAutoImport');
  
  addDebugLog(`localStorageæ¨™è¨˜ - autoImportFlag: ${autoImportFlag}, forceAutoImport: ${forceAutoImport}`);
  
  // æª¢æŸ¥æ™‚é–“æˆ³
  const isRecentFlag = autoImportTimestamp && (Date.now() - parseInt(autoImportTimestamp)) < 300000;
  addDebugLog(`æ™‚é–“æˆ³æª¢æŸ¥ - isRecentFlag: ${isRecentFlag}`);
  
  // æª¢æŸ¥æ˜¯å¦æœ‰å¾…å°å…¥çš„æ•¸æ“š
  const storedData = localStorage.getItem('cncCalculatorData');
  addDebugLog(`æ˜¯å¦æœ‰å„²å­˜æ•¸æ“š: ${!!storedData}`);
  
  if (storedData) {
    const shouldTriggerAutoImport = 
      (fromCalculator && shouldAutoImport) || 
      (autoImportFlag === 'true' && isRecentFlag) ||
      (forceAutoImport === 'true');
      
    addDebugLog(`æ˜¯å¦æ‡‰è©²è§¸ç™¼è‡ªå‹•å°å…¥: ${shouldTriggerAutoImport}`);
    
    if (shouldTriggerAutoImport) {
      // æ¸…é™¤è‡ªå‹•å°å…¥æ¨™è¨˜
      localStorage.removeItem('autoImportFlag');
      localStorage.removeItem('autoImportTimestamp');
      localStorage.removeItem('forceAutoImport');
      
      addDebugLog('é–‹å§‹è‡ªå‹•å°å…¥æµç¨‹...');
      
      // é¡¯ç¤ºè‡ªå‹•å°å…¥æç¤º
      showAutoImportNotice();
      
      setTimeout(() => {
        addDebugLog('åŸ·è¡Œè‡ªå‹•å°å…¥...');
        const success = importFromCalculator();
        hideAutoImportNotice();
        
        if (success) {
          showImportStatus('success', 'ğŸ‰ å·²è‡ªå‹•å¾CNCè¨ˆç®—å™¨å°å…¥æ•¸æ“šä¸¦ç”ŸæˆG-CODEï¼');
          
          // è‡ªå‹•æ»¾å‹•åˆ°çµæœå€åŸŸ
          setTimeout(() => {
            const outputSection = document.querySelector('.right-column');
            if (outputSection) {
              outputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 1500);
        }
      }, 1200);
      
    } else {
      // å¦å‰‡åªé¡¯ç¤ºæç¤º
      showImportStatus('warning', 'ğŸ’¡ åµæ¸¬åˆ°CNCè¨ˆç®—å™¨æ•¸æ“šï¼é»æ“Šã€Œæ‰‹å‹•å°å…¥æ•¸æ“šã€æŒ‰éˆ•è¼‰å…¥ã€‚');
    }
  } else if (fromCalculator) {
    // å¦‚æœæ˜¯å¾è¨ˆç®—å™¨è·³è½‰ä½†æ²’æœ‰æ•¸æ“š
    showImportStatus('error', 'âŒ æœªæ‰¾åˆ°CNCè¨ˆç®—å™¨æ•¸æ“šï¼è«‹å…ˆåœ¨CNCè¨ˆç®—å™¨ä¸­è¨ˆç®—ä¸¦å°å‡ºæ•¸æ“šã€‚');
  }
}

function showAutoImportNotice() {
  const notice = document.getElementById('autoImportNotice');
  notice.style.display = 'block';
  addDebugLog('é¡¯ç¤ºè‡ªå‹•å°å…¥æç¤º');
}

function hideAutoImportNotice() {
  const notice = document.getElementById('autoImportNotice');
  notice.style.display = 'none';
  addDebugLog('éš±è—è‡ªå‹•å°å…¥æç¤º');
}

function showImportStatus(type, message) {
  const statusDiv = document.getElementById('importStatus');
  statusDiv.className = `status-message status-${type}`;
  statusDiv.textContent = message;
  statusDiv.style.display = 'block';
  
  addDebugLog(`é¡¯ç¤º${type}è¨Šæ¯: ${message}`);
  
  // æ ¹æ“šè¨Šæ¯é¡å‹è¨­å®šä¸åŒçš„éš±è—å»¶é²
  const hideDelay = type === 'success' ? 8000 : 6000;
  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, hideDelay);
}

function generate() {
  try {
    addDebugLog('é–‹å§‹ç”ŸæˆG-CODE...');
    
    const productName = document.getElementById('productName').value || "æœªå‘½å";
    const A = document.getElementById('coordA').value || "X-100 Y100";
    const B = document.getElementById('coordB').value || "X-100 Y100";
    const C = document.getElementById('coordC').value || "X-100 Y100";
    const D = document.getElementById('coordD').value || "X-100 Y100";
    const sub = document.getElementById('angleGcodeOutput').value.split('\n').map(line => line.trim()).filter(line => line).join('\n');
    const angle = document.getElementById('angle').value || "45";

    addDebugLog(`ä½¿ç”¨åƒæ•¸ - ç”¢å“åç¨±: ${productName}, è§’åº¦: ${angle}`);
    addDebugLog(`åº§æ¨™ - A: ${A}, B: ${B}, C: ${C}, D: ${D}`);

    const output = `(648)
(${productName})
(C=${angle})
(!!!!!!G54!!!!!!)
(---------O)
(----------)
(12mm mill , T8 H8 S1280 F120)




(DRY RUN)

N1
(12mmMILL  DOWN)
G0G90G54${A}(!!A!!) (1)M3S1280
G43H8Z50.
Z30.
M1

G0G90${A}(!!A!!)
G1G90Z20.000  (è™•ç†æ·±åº¦: Z20.000)
M98H100



G0G90Z120.
M5



N2
(12mmMILL   UP)
G0G90G54${B}(!!B!!) (1)M3S1280
G43H8Z50.
Z30.
M1

G0G90${B}(!!B!!)
G1G90Z20.000   (è™•ç†æ·±åº¦: Z20.000)
M98H100

G0G90Z120.
M5


(DRY RUN CUT)

N3
(12mm mill   CUT 0)
G0G90G54${C}(!!C!!) M3S1280
G43H8Z70.
M1
G0G90Z30.(å®‰å…¨é™åˆ€)
M1(!!)

G1G90Z20.000   F400(è™•ç†æ·±åº¦: Z20.000)
(ç²¾ä¿®é–‹å§‹)
G1G90${D}(!!D!!) F400
(ç²¾ä¿®çµæŸ)

G0G90Z120.
M5







N4
(12mmMILL  UP !!A!!)
G0G90G54${A}(!!A!!) (1)M3S1280
G43H8Z50.
Z30.M8
M1
Z10.
G0G90${A}(!!A!!)
G1G90Z-20.000  F500 (è™•ç†æ·±åº¦: Z-20.000)
M98H100

G0G90${A}(!!A!!)
G1G90Z-34.500  F500 (è™•ç†æ·±åº¦: Z-35.000)
M98H100

G0G90Z120.M9
M5

N5
(12mmMILL   DOWN !!B!!)
G0G90G54${B}(!!B!!) (1)M3S1280
G43H8Z50.
Z30.M8
M1
Z10.
G0G90${B}(!!B!!)
G1G90Z-20.000  F500 (è™•ç†æ·±åº¦: Z-20.000)
M98H100

G0G90${B}(!!B!!)
G1G90Z-34.500  F500 (è™•ç†æ·±åº¦: Z-35.000)
M98H100

G0G90Z120.M9
M5

(~~~CUT~~~~)
N6
(12mm mill   CUT 1)
G0G90G54${C}(!!C!!) M3S1280
G43H8Z70.
M8
M1
G0G90Z30.(å®‰å…¨é™åˆ€)
M1
G0G90Z10.(å®‰å…¨é™åˆ€)
M1
(!!)

G1G90Z-10.000 F300 (è™•ç†æ·±åº¦: Z-10.000)
(ç²¾ä¿®é–‹å§‹)
G1G90${D}(!!D!!) F200
(ç²¾ä¿®çµæŸ)

G0G90Z120.M9
M5

N7
(12mm mill   CUT 2)
G0G90G54${C}(!!C!!) M3S1280
G43H8Z70.
M8
M1
G0G90Z30.(å®‰å…¨é™åˆ€)
M1
G0G90Z10.(å®‰å…¨é™åˆ€)
M1
(!!)

G1G90Z-32.000 F500 (è™•ç†æ·±åº¦: Z-31.000)
(ç²¾ä¿®é–‹å§‹)
G1G90${D}(!!D!!) F200
(ç²¾ä¿®çµæŸ)

G0G90Z120.M9
M5

G0G90X2500.

M30

N100
${sub}
G0G90Z35.
M99`;

    document.getElementById('output').value = output;
    addDebugLog('G-CODEç”Ÿæˆå®Œæˆ');
    
  } catch (error) {
    addDebugLog(`G-CODEç”ŸæˆéŒ¯èª¤: ${error.message}`);
    console.error('G-CODEç”ŸæˆéŒ¯èª¤:', error);
  }
}

function copyToClipboard() {
  try {
    const output = document.getElementById('output');
    const content = output.value;
    
    if (!content) {
      addDebugLog('è¤‡è£½å¤±æ•—ï¼šæ²’æœ‰å…§å®¹å¯è¤‡è£½');
      return;
    }
    
    addDebugLog('é–‹å§‹è¤‡è£½åˆ°å‰ªè²¼æ¿...');
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(content).then(() => {
        addDebugLog('ä½¿ç”¨ç¾ä»£APIè¤‡è£½æˆåŠŸ');
        showCopySuccess();
      }).catch(() => {
        addDebugLog('ç¾ä»£APIè¤‡è£½å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ³•');
        fallbackCopy(content);
      });
    } else {
      addDebugLog('ç€è¦½å™¨ä¸æ”¯æ´ç¾ä»£APIï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ³•');
      fallbackCopy(content);
    }
  } catch (error) {
    addDebugLog(`è¤‡è£½éŒ¯èª¤: ${error.message}`);
  }
}

function fallbackCopy(content) {
  try {
    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = content;
    tempTextarea.style.position = 'fixed';
    tempTextarea.style.top = '-1000px';
    document.body.appendChild(tempTextarea);
    tempTextarea.focus();
    tempTextarea.select();
    
    const successful = document.execCommand('copy');
    document.body.removeChild(tempTextarea);
    
    if (successful) {
      addDebugLog('å‚™ç”¨æ–¹æ³•è¤‡è£½æˆåŠŸ');
      showCopySuccess();
    } else {
      addDebugLog('å‚™ç”¨æ–¹æ³•è¤‡è£½å¤±æ•—');
    }
  } catch (err) {
    addDebugLog(`å‚™ç”¨è¤‡è£½æ–¹æ³•éŒ¯èª¤: ${err.message}`);
  }
}

function showCopySuccess() {
  // é¡¯ç¤ºè¤‡è£½æˆåŠŸçš„è¦–è¦ºå›é¥‹
  const outputTextarea = document.getElementById('output');
  const originalBorder = outputTextarea.style.borderColor;
  
  outputTextarea.style.borderColor = '#a6e3a1';
  setTimeout(() => {
    outputTextarea.style.borderColor = originalBorder;
  }, 1000);
  
  addDebugLog('é¡¯ç¤ºè¤‡è£½æˆåŠŸå›é¥‹');
}

function downloadGcode() {
  try {
    const content = document.getElementById('output').value;
    if (!content) {
      addDebugLog('ä¸‹è¼‰å¤±æ•—ï¼šæ²’æœ‰å…§å®¹å¯ä¸‹è¼‰');
      return;
    }
    
    const productName = document.getElementById('productName').value || "gcode";
    
    addDebugLog(`é–‹å§‹ä¸‹è¼‰æ–‡ä»¶: ${productName}.txt`);
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const downloadLink = document.createElement('a');
    downloadLink.href = url;
    downloadLink.download = productName + '.txt';
    
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    URL.revokeObjectURL(url);
    
    addDebugLog('æ–‡ä»¶ä¸‹è¼‰å®Œæˆ');
  } catch (error) {
    addDebugLog(`ä¸‹è¼‰éŒ¯èª¤: ${error.message}`);
  }
}

function clearAllFields() {
  try {
    addDebugLog('åŸ·è¡Œå…¨éƒ¨æ¸…é™¤...');
    
    // æ¸…é™¤åº§æ¨™è¨­å®š
    document.getElementById('productName').value = '';
    document.getElementById('coordA').value = '';
    document.getElementById('coordB').value = '';
    document.getElementById('coordC').value = '';
    document.getElementById('coordD').value = '';
    
    // é‡ç½®è§’åº¦è¨ˆç®—å™¨
    document.getElementById('angle').value = '45';
    document.getElementById('diameter').value = '18';
    
    // æ¸…é™¤è¼¸å‡º
    document.getElementById('angleGcodeOutput').value = '';
    document.getElementById('output').value = '';
    
    // æ¸…é™¤å°å…¥ç‹€æ…‹
    document.getElementById('importStatus').style.display = 'none';
    document.getElementById('importPreview').style.display = 'none';
    document.getElementById('autoImportNotice').style.display = 'none';
    
    // æ¸…é™¤æœ¬åœ°æ•¸æ“š
    localStorage.removeItem('cncCalculatorData');
    localStorage.removeItem('autoImportFlag');
    localStorage.removeItem('autoImportTimestamp');
    localStorage.removeItem('forceAutoImport');
    
    // é‡æ–°è¨ˆç®—è§’åº¦G-CODE
    generateAngleGCode();
    
    addDebugLog('å…¨éƒ¨æ¸…é™¤å®Œæˆ');
  } catch (error) {
    addDebugLog(`æ¸…é™¤éŒ¯èª¤: ${error.message}`);
  }
}

// é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
window.onload = function() {
  try {
    addDebugLog('G-CODEç”Ÿæˆå™¨é é¢è¼‰å…¥é–‹å§‹');
    
    // é¦–å…ˆç”Ÿæˆé è¨­çš„è§’åº¦G-CODE
    generateAngleGCode();
    
    // æ·»åŠ æ¸…é™¤æŒ‰éˆ•äº‹ä»¶
    const clearButton = document.getElementById('clearAllButton');
    if (clearButton) {
      clearButton.addEventListener('click', clearAllFields);
      addDebugLog('æ¸…é™¤æŒ‰éˆ•äº‹ä»¶ç¶å®šå®Œæˆ');
    }
    
    // æ·»åŠ è¼¸å…¥å­—æ®µè®ŠåŒ–ç›£è½å™¨
    const inputFields = ['productName', 'coordA', 'coordB', 'coordC', 'coordD', 'angle'];
    inputFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('input', () => {
          // å¦‚æœå·²ç¶“æœ‰G-codeè¼¸å‡ºï¼Œå‰‡é‡æ–°ç”Ÿæˆ
          const output = document.getElementById('output');
          if (output.value.trim()) {
            setTimeout(() => {
              generate();
            }, 100);
          }
        });
      }
    });
    
    addDebugLog('è¼¸å…¥æ¬„ä½äº‹ä»¶ç¶å®šå®Œæˆ');
    
    // å°‡é—œéµå‡½æ•¸æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.importFromCalculator = importFromCalculator;
    window.autoImportOnLoad = autoImportOnLoad;
    
    addDebugLog('å…¨å±€å‡½æ•¸æš´éœ²å®Œæˆ');
    
    // çŸ­æš«å»¶é²å¾Œæª¢æŸ¥è‡ªå‹•å°å…¥
    setTimeout(() => {
      addDebugLog('é–‹å§‹æª¢æŸ¥è‡ªå‹•å°å…¥...');
      autoImportOnLoad();
    }, 800);
    
    addDebugLog('G-CODEç”Ÿæˆå™¨åˆå§‹åŒ–å®Œæˆ');
    
  } catch (error) {
    addDebugLog(`åˆå§‹åŒ–éŒ¯èª¤: ${error.message}`);
    console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
  }
};

// ç¢ºä¿æ‰€æœ‰å‡½æ•¸éƒ½èƒ½æ­£å¸¸åŸ·è¡Œçš„æ¸¬è©¦
setTimeout(() => {
  addDebugLog('åŸ·è¡ŒåŠŸèƒ½æ¸¬è©¦...');
  
  // æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
  try {
    generateAngleGCode();
    addDebugLog('âœ“ è§’åº¦G-CODEç”ŸæˆåŠŸèƒ½æ­£å¸¸');
  } catch (e) {
    addDebugLog(`âœ— è§’åº¦G-CODEç”ŸæˆåŠŸèƒ½ç•°å¸¸: ${e.message}`);
  }
  
  try {
    const testData = localStorage.getItem('cncCalculatorData');
    addDebugLog(`âœ“ localStorageè®€å–åŠŸèƒ½æ­£å¸¸ (æ•¸æ“š: ${testData ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'})`);
  } catch (e) {
    addDebugLog(`âœ— localStorageè®€å–åŠŸèƒ½ç•°å¸¸: ${e.message}`);
  }
  
}, 2000);
</script>

</body>
</html>