<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>651 CNCè¨ˆç®—å™¨ - G55å°ˆç”¨ç‰ˆæœ¬</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            border-bottom: 3px solid #00695c;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #00695c;
            margin: 0;
            font-size: 24px;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .section h3 {
            color: #00695c;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 15px;
        }
        
        label {
            font-weight: bold;
            min-width: 120px;
        }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 120px;
            font-size: 14px;
        }
        
        select {
            width: 150px;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            font-weight: bold;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #00695c;
        }
        
        .btn-secondary:hover {
            background: #004d40;
        }
        
        .btn-warning {
            background: #ff9800;
        }
        
        .btn-warning:hover {
            background: #e68900;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-g55 {
            background: #94e2d5;
            color: #1e1e2e;
        }
        
        .btn-g55:hover {
            background: #7dd3c0;
        }
        
        .g55-header {
            background: #e0f2f1;
            border: 2px solid #00695c;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .g55-header h3 {
            color: #00695c;
            margin: 0 0 10px 0;
            font-size: 20px;
        }
        
        .g55-indicator {
            background: rgba(148, 226, 213, 0.3);
            color: #00695c;
            border: 1px solid #94e2d5;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
            display: inline-block;
            font-weight: bold;
        }
        
        .results {
            background: #e0f2f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .results h4 {
            color: #00695c;
            margin-top: 0;
        }
        
        .coord-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .coord-table th, .coord-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .coord-table th {
            background: #00695c;
            color: white;
        }
        
        .export-section {
            background: #fff8e1;
            border: 2px solid #ffb74d;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .data-preview {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .export-buttons button {
            flex: 1;
            min-width: 180px;
        }
        
        .hidden {
            display: none;
        }
        
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .scroll-up-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #edcf6c;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            display: none;
        }
        
        .scroll-up-btn:hover {
            background: #ce8c3a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .scroll-up-btn.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ç‰ˆæœ¬è™Ÿçµ„ä»¶æ¨£å¼ */
        .version-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            z-index: 1000;
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .version-tooltip {
            position: absolute;
            top: 50px;
            right: 0;
            background: #2d3748;
            color: white;
            padding: 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            max-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .version-tooltip::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #2d3748;
        }
        
        .version-tooltip.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .version-tooltip h4 {
            margin: 0 0 8px 0;
            color: #68d391;
            font-size: 1rem;
        }
        
        .version-tooltip .version-info {
            margin: 8px 0;
            padding: 4px 0;
        }
        
        .version-tooltip .version-stability {
            display: inline-block;
            background: #68d391;
            color: #1a202c;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .version-tooltip .features {
            margin: 12px 0;
            padding-left: 16px;
        }
        
        .version-tooltip .features li {
            margin: 4px 0;
            color: #e2e8f0;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .version-badge {
                top: 15px;
                right: 15px;
                font-size: 0.8rem;
                padding: 6px 12px;
            }
            
            .version-tooltip {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                right: auto;
                max-width: 90vw;
            }
            
            .version-tooltip::before {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ç‰ˆæœ¬è™Ÿå¾½ç«  -->
    <div class="version-badge">
        <span>ğŸš€</span>
        <span>v4.1.0</span>
    </div>
    
    <!-- ç‰ˆæœ¬è™Ÿæç¤ºæ¡† -->
    <div class="version-tooltip" id="versionTooltip">
        <h4>651 CNCè¨ˆç®—å™¨</h4>
        <div class="version-info">
            <span>v4.1.0</span>
            <span class="version-stability" style="background-color: #20e15d;">å·²é‡ç”¢</span>
            
        </div> 
        <p>æ›´æ–°æ—¥æœŸï¼š2025å¹´7æœˆ17æ—¥</p>
        <ul class="features">
            -------------é–‹ç™¼ç´€éŒ„-------------
            <li>ğŸ¯ G55å°ˆç”¨åº§æ¨™ç³»çµ±</li>
            <li>ğŸ“ æ™ºèƒ½æ¢¯å½¢è¨ˆç®—</li>
            <li>ğŸ”— ä¸€éµå°å‡ºG-CODE</li>
            <li>ğŸ”— å„ªåŒ–G-CODEç¨‹å¼</li>
            -------------è£½ä½œæ­·ç¨‹-------------
            <li>ğŸ”— 7/15 2è™Ÿæ©ŸG55åšå®Œ651-2 Lã€R</Ri:a></li>
        </ul>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¯ 651 CNCè¨ˆç®—å™¨ - G55å°ˆç”¨ç‰ˆæœ¬</h1>
            <p>å°ˆç‚ºG55åº§æ¨™ç³»çµ±è¨­è¨ˆçš„CNCè¨ˆç®—å™¨</p>
        </div>
        
        <!-- G55ç‰ˆæœ¬èªªæ˜ -->
        <div class="g55-header">
            <h3>G55 å·¦å´åŠ å·¥æ¨¡å¼</h3>
            <div class="g55-indicator">å·¦å´ç‰ˆæœ¬ - åŸé»(0,0)åœ¨å³ä¸Šè§’</div>
            <p>è·¯ç·šæ–¹å‘ï¼šA2èµ·é» â†’ A1çµ‚é»</p>
        </div>
        
        <!-- ç«¯é»è¼¸å…¥å€ -->
        <div class="section" id="coordinateInput">
            <h3>ğŸ“ ç«¯é»åº§æ¨™è¼¸å…¥</h3>
            <div class="input-row">
                <label>ç”¢å“åç¨±ï¼š</label>
                <input type="text" id="productName" placeholder="å¦‚ï¼š31F-07" value="31F-07">
            </div>
            <div class="input-row">
                <label>ä¸Šæ–¹ç«¯é»ï¼š</label>
                <input type="text" id="topPoint" placeholder="X100 Y0.00" value="X-100 Y0.00">
            </div>
            <div class="input-row">
                <label>ä¸‹æ–¹ç«¯é»ï¼š</label>
                <input type="text" id="bottomPoint" placeholder="X50 Y-50" value="X-50 Y-50">
            </div>
        </div>
        
        <!-- åƒæ•¸è¨­å®šå€ -->
        <div class="section">
            <h3>âš™ï¸ åˆ€å…·åƒæ•¸è¨­å®š</h3>
            <div class="input-row">
                <label>ä¸Šé‚Šåç§»ï¼š</label>
                <input type="number" id="topOffset" value="9" step="0.1">
                <span>mm</span>
            </div>
            <div class="input-row">
                <label>ä¸‹é‚Šåç§»ï¼š</label>
                <input type="number" id="bottomOffset" value="4.29" step="0.1">
                <span>mm</span>
            </div>
            <div class="input-row">
                <label>æ–œé‚Šåç§»ï¼š</label>
                <input type="number" id="slopeOffset" value="6" step="0.1">
                <span>mm</span>
            </div>
            <div class="input-row">
                <label>Xåç§»é‡ï¼š</label>
                <input type="number" id="xOffset" value="60" step="0.1">
                <span>mm</span>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰éˆ• -->
        <div style="text-align: center;">
            <button class="btn" onclick="calculateCNC()">ğŸ”§ è¨ˆç®—CNCé»ä½</button>
            <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤é‡ç½®</button>
        </div>
        
        <!-- è¨ˆç®—çµæœå€ -->
        <div id="resultsSection" style="display: none;">
            <div class="results">
                <h4>ğŸ“Š CNCé»ä½è¨ˆç®—çµæœ</h4>
                <table class="coord-table">
                    <tr>
                        <th>é»ä½åç¨±</th>
                        <th>Xåº§æ¨™</th>
                        <th>Yåº§æ¨™</th>
                        <th>èªªæ˜</th>
                    </tr>
                    <tbody id="coordTable">
                    </tbody>
                </table>
                
                <div style="margin-top: 20px;">
                    <p><strong>ğŸ¯ æ¢¯å½¢åƒæ•¸ï¼š</strong></p>
                    <p id="trapezoidParams"></p>
                </div>
            </div>
            
            <!-- å°å‡ºæŒ‰éˆ•å€ -->
            <div class="export-section">
                <h4>ğŸ“¤ å°å‡ºè‡³G-CODEç”Ÿæˆå™¨</h4>
                <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å°‡æ•¸æ“šå°å‡ºä¸¦é–‹å•ŸG55 G-CODEç”Ÿæˆå™¨ï¼š</p>
                
                <div class="export-buttons">
                    <button class="btn btn-g55" onclick="exportAndOpenGCode('G55')">ğŸ”— å°å‡ºä¸¦é–‹å•Ÿ G55</button>
                    <button class="btn btn-warning" onclick="exportToGCode()">ğŸ“¤ åƒ…å°å‡ºæ•¸æ“š</button>
                    <button class="btn btn-secondary" onclick="copyData()">ğŸ“‹ è¤‡è£½æ•¸æ“š</button>
                </div>
                
                <div class="success-msg" id="successMsg"></div>
                <div class="error-msg" id="errorMsg"></div>
                
                <details>
                    <summary>ğŸ“„ æŸ¥çœ‹æ•¸æ“šå…§å®¹</summary>
                    <div class="data-preview" id="dataPreview"></div>
                </details>
            </div>
        </div>
    </div>
    
    <!-- å¾€ä¸Šæµ®å‹•æŒ‰éˆ• -->
    <button class="scroll-up-btn" id="scrollUpBtn" onclick="scrollToCoordinateInput()" title="å›åˆ°ç«¯é»è¼¸å…¥">
        â–²
    </button>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentCNCData = null;
        let debugInfo = [];
        
        function addDebugInfo(info) {
            debugInfo.push(info);
            console.log(info);
        }
        
        function calculateCNC() {
            console.log('calculateCNC å‡½æ•¸è¢«èª¿ç”¨');
            
            debugInfo = []; // æ¸…é™¤èª¿è©¦ä¿¡æ¯
            
            try {
                // å–å¾—è¼¸å…¥å€¼ä¸¦è§£æCADæ ¼å¼åº§æ¨™
                const productName = document.getElementById('productName').value || "æœªå‘½å";
                const topPointStr = document.getElementById('topPoint').value;
                const bottomPointStr = document.getElementById('bottomPoint').value;
                
                addDebugInfo(`è¼¸å…¥å€¼ - ç”¢å“: ${productName}, ä¸Šæ–¹: ${topPointStr}, ä¸‹æ–¹: ${bottomPointStr}`);
                
                // è§£æCADæ ¼å¼åº§æ¨™ (ä¾‹ï¼šX100 Y0.00)
                function parseCADCoord(coordStr) {
                    const xMatch = coordStr.match(/X(-?\d+\.?\d*)/);
                    const yMatch = coordStr.match(/Y(-?\d+\.?\d*)/);
                    if (!xMatch || !yMatch) return null;
                    return {
                        x: parseFloat(xMatch[1]),
                        y: parseFloat(yMatch[1])
                    };
                }
                
                const topPoint = parseCADCoord(topPointStr);
                const bottomPoint = parseCADCoord(bottomPointStr);
                
                if (!topPoint || !bottomPoint) {
                    showError('è«‹è¼¸å…¥æ­£ç¢ºçš„CADåº§æ¨™æ ¼å¼ï¼Œä¾‹ï¼šX100 Y0.00');
                    return;
                }
                
                addDebugInfo(`è§£æåº§æ¨™ - ä¸Šæ–¹: (${topPoint.x}, ${topPoint.y}), ä¸‹æ–¹: (${bottomPoint.x}, ${bottomPoint.y})`);
                
                // å–å¾—åç§»åƒæ•¸
                const topOffset = parseFloat(document.getElementById('topOffset').value);
                const bottomOffset = parseFloat(document.getElementById('bottomOffset').value);
                const slopeOffset = parseFloat(document.getElementById('slopeOffset').value);
                const xOffset = parseFloat(document.getElementById('xOffset').value);
                
                addDebugInfo(`åç§»åƒæ•¸ - ä¸Šé‚Š: ${topOffset}, ä¸‹é‚Š: ${bottomOffset}, æ–œé‚Š: ${slopeOffset}, Xåç§»: ${xOffset}`);
                
                // è¨ˆç®—æ¢¯å½¢åƒæ•¸
                const height = Math.abs(topPoint.y - bottomPoint.y);
                const topLength = Math.abs(topPoint.x);
                const bottomLength = Math.abs(bottomPoint.x);
                const horizontalDiff = Math.abs(topPoint.x - bottomPoint.x);
                const verticalDiff = Math.abs(topPoint.y - bottomPoint.y);
                const angle = horizontalDiff > 0 ? Math.atan(verticalDiff / horizontalDiff) * (180 / Math.PI) : 0;
                
                addDebugInfo(`æ¢¯å½¢åƒæ•¸ - é«˜åº¦: ${height}, è§’åº¦: ${angle}Â°`);
                
                // è¨ˆç®—G55åº§æ¨™
                const cncPoints = calculateG55Coordinates(topPoint, bottomPoint, topOffset, bottomOffset, slopeOffset, xOffset);
                
                // å„²å­˜å®Œæ•´æ•¸æ“š
                currentCNCData = {
                    version: 'G55',
                    productName: productName,
                    angle: angle,
                    trapezoid: {
                        topLength: topLength,
                        bottomLength: bottomLength,
                        height: height
                    },
                    coordinates: cncPoints
                };
                
                addDebugInfo(`è¨ˆç®—å®Œæˆï¼Œç”Ÿæˆ ${Object.keys(cncPoints).length} å€‹é»ä½`);
                
                // é¡¯ç¤ºçµæœ
                displayResults(currentCNCData);
                
            } catch (error) {
                console.error('è¨ˆç®—éŒ¯èª¤:', error);
                addDebugInfo(`è¨ˆç®—éŒ¯èª¤: ${error.message}`);
                showError('è¨ˆç®—éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }
        
        function calculateG55Coordinates(topPoint, bottomPoint, topOffset, bottomOffset, slopeOffset, xOffset) {
            addDebugInfo('é–‹å§‹G55åº§æ¨™è¨ˆç®— - 651å°ˆç”¨ç‰ˆæœ¬');
            
            // å°‡è¼¸å…¥åº§æ¨™è½‰æ›ç‚ºçµ•å°å€¼é€²è¡Œè¨ˆç®—
            const absTopX = Math.abs(topPoint.x);
            const absBottomX = Math.abs(bottomPoint.x);
            
            addDebugInfo(`çµ•å°å€¼ç«¯é» - ä¸Šæ–¹: (${absTopX}, ${topPoint.y}), ä¸‹æ–¹: (${absBottomX}, ${bottomPoint.y})`);
            
            // å››å€‹é ‚é»åº§æ¨™
            const A = {x: 0, y: topPoint.y};
            const B = {x: 0, y: bottomPoint.y};
            const C = {x: absBottomX, y: bottomPoint.y};
            const D = {x: absTopX, y: topPoint.y};
            
            addDebugInfo(`G55æ¢¯å½¢é ‚é» - A: (${A.x}, ${A.y}), B: (${B.x}, ${B.y}), C: (${C.x}, ${C.y}), D: (${D.x}, ${D.y})`);
            
            // æ–œé‚Šåç§»å‘é‡è¨ˆç®—
            const slopeDx = D.x - C.x;
            const slopeDy = D.y - C.y;
            const slopeAngle = Math.atan2(slopeDy, slopeDx);
            const perpAngle = slopeAngle - Math.PI/2;
            const perpX = Math.cos(perpAngle) * slopeOffset;
            const perpY = Math.sin(perpAngle) * slopeOffset;
            
            // è¨ˆç®—åç§»å¾Œçš„ç«¯é»
            const offsetTop = {
                x: D.x + perpX,
                y: D.y + perpY
            };
            const offsetBottom = {
                x: C.x + perpX,
                y: C.y + perpY
            };
            
            // åç§»ç·šæ–¹ç¨‹å¼è¨ˆç®—
            const slope = (offsetTop.y - offsetBottom.y) / (offsetTop.x - offsetBottom.x);
            const intercept = offsetTop.y - slope * offsetTop.x;
            
            // äº¤é»è¨ˆç®—å‡½æ•¸
            function getXAtY(y) {
                return (y - intercept) / slope;
            }
            
            // ä¸Šé‚Šç•Œå’Œä¸‹é‚Šç•Œ - ä½¿ç”¨651å°ˆç”¨è¨­å®š
            const upperBoundY = topPoint.y + topOffset;      // 0 + 9 = 9
            const lowerBoundY = bottomPoint.y + bottomOffset; // -50 + 4.29 = -45.71
            
            addDebugInfo(`G55 Yé‚Šç•Œ - ä¸Šé‚Šç•Œ: ${upperBoundY}, ä¸‹é‚Šç•Œ: ${lowerBoundY}`);
            
            // B3é»: ä¸Šé‚Šç•Œäº¤é» (æ–œåˆ‡çµ‚é»)
            const b3X = getXAtY(upperBoundY);
            const B3_point = {
                x: -Math.abs(b3X),  // G55ç‰ˆæœ¬Xåæ¨™ç‚ºè² æ•¸
                y: upperBoundY
            };
            
            // Aåˆ€è·¯çµ‚é»: Yåº§æ¨™è¨­å®šç‚º1.0 (651å°ˆç”¨è¨­å®š)
            const aY = 1.0;
            const aEndX = getXAtY(aY);
            const A_END_point = {
                x: -Math.abs(aEndX),  // G55ç‰ˆæœ¬Xåæ¨™ç‚ºè² æ•¸
                y: aY
            };
            
            // Båˆ€è·¯çµ‚é»: Yåº§æ¨™è¨­å®šç‚º-145.71 (651å°ˆç”¨è¨­å®š)
            const bY = -145.71;
            const bEndX = getXAtY(bY);
            const B_END_point = {
                x: -Math.abs(bEndX),  // G55ç‰ˆæœ¬Xåæ¨™ç‚ºè² æ•¸
                y: bY
            };
            
            // A1 (Aåˆ€è·¯èµ·é»): Aåˆ€è·¯çµ‚é»å¾€å·¦60mm
            const A1_point = {
                x: A_END_point.x - 60,  // å¾€å·¦60mm (Xæ¸›å°‘60)
                y: A_END_point.y
            };
            
            // B1 (Båˆ€è·¯èµ·é»): Båˆ€è·¯çµ‚é»å¾€å·¦60mm
            const B1_point = {
                x: B_END_point.x - 60,  // å¾€å·¦60mm (Xæ¸›å°‘60)
                y: B_END_point.y
            };
            
            addDebugInfo(`é—œéµé»ä½è¨ˆç®—çµæœ:`);
            addDebugInfo(`- Aåˆ€è·¯çµ‚é»: X${A_END_point.x}, Y${A_END_point.y}`);
            addDebugInfo(`- Båˆ€è·¯çµ‚é»: X${B_END_point.x}, Y${B_END_point.y}`);
            addDebugInfo(`- A1 (Aåˆ€è·¯èµ·é»): X${A1_point.x}, Y${A1_point.y}`);
            addDebugInfo(`- B1 (Båˆ€è·¯èµ·é»): X${B1_point.x}, Y${B1_point.y}`);
            addDebugInfo(`- B3 (æ–œåˆ‡çµ‚é»): X${B3_point.x}, Y${B3_point.y}`);
            
            // è¿”å›äº”å€‹é—œéµé»ä½ - ç”¨æ–¼å°å‡ºåˆ°G-CODEç”Ÿæˆå™¨
            return {
                A_END: {x: Math.round(A_END_point.x * 100) / 100, y: A_END_point.y, name: "Aåˆ€è·¯çµ‚é»"},
                B_END: {x: Math.round(B_END_point.x * 100) / 100, y: B_END_point.y, name: "Båˆ€è·¯çµ‚é»"},
                A1: {x: Math.round(A1_point.x * 100) / 100, y: A1_point.y, name: "A1 (Aåˆ€è·¯èµ·é»)"},
                B1: {x: Math.round(B1_point.x * 100) / 100, y: B1_point.y, name: "B1 (Båˆ€è·¯èµ·é»)"},
                B3: {x: Math.round(B3_point.x * 100) / 100, y: B3_point.y, name: "B3 (æ–œåˆ‡çµ‚é»)"}
            };
        }
        
        function displayResults(data) {
            // é¡¯ç¤ºçµæœå€åŸŸ
            document.getElementById('resultsSection').style.display = 'block';
            
            // å¡«å…¥åº§æ¨™è¡¨æ ¼
            const tableBody = document.getElementById('coordTable');
            tableBody.innerHTML = '';
            
            // åªé¡¯ç¤ºé—œéµé»ä½ï¼šA1ã€B1ã€B3 (éš±è—A_ENDã€B_END)
            const keyPoints = ['A1', 'B1', 'B3'];
            
            keyPoints.forEach(key => {
                if (data.coordinates[key]) {
                    const point = data.coordinates[key];
                    const row = tableBody.insertRow();
                    
                    // ç‚ºA1ã€B1ã€B3æ·»åŠ ç‰¹æ®Šæ¨™è¨˜
                    const markStyle = 'background: #ffeb3b; color: #333; font-weight: bold;';
                    const markIcon = 'â­ ';
                    
                    row.innerHTML = `
                        <td style="${markStyle}"><strong>${markIcon}${key}</strong></td>
                        <td style="${markStyle}">${point.x.toFixed(2)}</td>
                        <td style="${markStyle}">${point.y.toFixed(2)}</td>
                        <td style="${markStyle}">${point.name}</td>
                    `;
                }
            });
            
            // é¡¯ç¤ºæ¢¯å½¢åƒæ•¸
            document.getElementById('trapezoidParams').innerHTML = `
                ä¸Šé‚Šé•·åº¦: ${data.trapezoid.topLength.toFixed(2)}mm, 
                ä¸‹é‚Šé•·åº¦: ${data.trapezoid.bottomLength.toFixed(2)}mm, 
                é«˜åº¦: ${data.trapezoid.height.toFixed(2)}mm, 
                æ–œè§’: ${data.angle.toFixed(2)}Â°
            `;
            
            // æ›´æ–°æ•¸æ“šé è¦½
            updateDataPreview();
            
            // æ»¾å‹•åˆ°çµæœå€åŸŸ
            document.getElementById('resultsSection').scrollIntoView({behavior: 'smooth'});
        }
        
        function updateDataPreview() {
            if (!currentCNCData) return;
            
            // ä½¿ç”¨æ¨™æº–åº§æ¨™æ ¼å¼ (ä¸ä»¥é»çµå°¾)
            const coordA1 = `X${currentCNCData.coordinates.A1.x.toFixed(3)}Y${currentCNCData.coordinates.A1.y.toFixed(3)}`;
            const coordB1 = `X${currentCNCData.coordinates.B1.x.toFixed(3)}Y${currentCNCData.coordinates.B1.y.toFixed(3)}`;
            const coordAEnd = `X${currentCNCData.coordinates.A_END.x.toFixed(3)}Y${currentCNCData.coordinates.A_END.y.toFixed(3)}`;
            const coordBEnd = `X${currentCNCData.coordinates.B_END.x.toFixed(3)}Y${currentCNCData.coordinates.B_END.y.toFixed(3)}`;
            const coordB3 = `X${currentCNCData.coordinates.B3.x.toFixed(3)}Y${currentCNCData.coordinates.B3.y.toFixed(3)}`;
            
            const exportData = {
                version: currentCNCData.version,
                productName: currentCNCData.productName,
                angle: currentCNCData.angle.toFixed(2),
                coordA: coordA1,       // ä¿®æ”¹ï¼šA1åº§æ¨™æ”¹ç‚ºcoordA
                coordB: coordB1,       // ä¿®æ”¹ï¼šB1åº§æ¨™æ”¹ç‚ºcoordB
                coordC: coordB3        // ä¿®æ”¹ï¼šB3åº§æ¨™æ”¹ç‚ºcoordC
            };
            
            document.getElementById('dataPreview').textContent = JSON.stringify(exportData, null, 2);
            
            // æ·»åŠ èª¿è©¦ä¿¡æ¯
            addDebugInfo(`æ•¸æ“šé è¦½æ›´æ–°: A1=${coordA1}, Açµ‚é»=${coordAEnd}, B1=${coordB1}, Bçµ‚é»=${coordBEnd}, B3=${coordB3}`);
        }
        
        function exportToGCode() {
            if (!currentCNCData) {
                showError('è«‹å…ˆè¨ˆç®—CNCé»ä½');
                return;
            }
            
            try {
                // ä¿®æ”¹ç‚ºå°æ•¸é»å¾Œå…©ä½ç²¾åº¦
                const coordA1 = `X${currentCNCData.coordinates.A1.x.toFixed(2)}Y${currentCNCData.coordinates.A1.y.toFixed(2)}`;
                const coordB1 = `X${currentCNCData.coordinates.B1.x.toFixed(2)}Y${currentCNCData.coordinates.B1.y.toFixed(2)}`;
                const coordAEnd = `X${currentCNCData.coordinates.A_END.x.toFixed(2)}Y${currentCNCData.coordinates.A_END.y.toFixed(2)}`;
                const coordBEnd = `X${currentCNCData.coordinates.B_END.x.toFixed(2)}Y${currentCNCData.coordinates.B_END.y.toFixed(2)}`;
                const coordB3 = `X${currentCNCData.coordinates.B3.x.toFixed(2)}Y${currentCNCData.coordinates.B3.y.toFixed(2)}`;
                
                const exportData = {
                    version: currentCNCData.version,
                    productName: currentCNCData.productName,
                    angle: currentCNCData.angle.toFixed(2),
                    coordA: coordA1,       // ä¿®æ”¹ï¼šA1åº§æ¨™æ”¹ç‚ºcoordA
                    coordB: coordB1,       // ä¿®æ”¹ï¼šB1åº§æ¨™æ”¹ç‚ºcoordB
                    coordC: coordB3        // ä¿®æ”¹ï¼šB3åº§æ¨™æ”¹ç‚ºcoordC
                };
                
                const dataStr = JSON.stringify(exportData);
                localStorage.setItem('cncCalculatorData', dataStr);
                localStorage.setItem('autoImportFlag', 'true');
                localStorage.setItem('autoImportTimestamp', Date.now().toString());
                localStorage.setItem('selectedVersion', 'G55');
                
                showSuccess(`âœ… G55æ•¸æ“šå·²æˆåŠŸå°å‡ºåˆ°æœ¬åœ°å„²å­˜ï¼`);
                console.log('å°å‡ºæ•¸æ“š:', exportData);
                
                // æ·»åŠ èª¿è©¦ä¿¡æ¯
                addDebugInfo(`å°å‡ºæ•¸æ“š: ${dataStr}`);
                
            } catch (error) {
                console.error('å°å‡ºéŒ¯èª¤è©³æƒ…:', error);
                showError('æ•¸æ“šå°å‡ºå¤±æ•—ï¼š' + error.message);
                addDebugInfo(`å°å‡ºéŒ¯èª¤: ${error.message}`);
            }
        }
        
        function exportAndOpenGCode(version) {
            if (!currentCNCData) {
                showError('è«‹å…ˆè¨ˆç®—CNCé»ä½');
                return;
            }
            
            exportToGCode();
            
            setTimeout(() => {
                try {
                    localStorage.setItem('autoImportFlag', 'true');
                    localStorage.setItem('autoImportTimestamp', Date.now().toString());
                    localStorage.setItem('forceAutoImport', 'true');
                    localStorage.setItem('selectedVersion', 'G55');
                    
                    const filename = '651_g55_gcode.html';
                    const targetUrl = `${filename}?from=calculator&autoImport=true&version=G55&t=${Date.now()}`;
                    
                    const newWindow = window.open(targetUrl, 'gcodeGeneratorG55', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                    
                    if (newWindow) {
                        showSuccess(`âœ… G55æ•¸æ“šå·²å°å‡ºä¸¦æ­£åœ¨æ‰“é–‹G-CODEç”Ÿæˆå™¨...`);
                    } else {
                        showError(`âŒ ç€è¦½å™¨é˜»æ­¢äº†å½ˆå‡ºè¦–çª—`);
                        setTimeout(() => {
                            if (confirm(`ç„¡æ³•æ‰“é–‹æ–°è¦–çª—ï¼Œæ˜¯å¦åœ¨ç•¶å‰é é¢æ‰“é–‹G55 G-CODEç”Ÿæˆå™¨ï¼Ÿ`)) {
                                window.location.href = targetUrl;
                            }
                        }, 1000);
                    }
                } catch (error) {
                    showError(`âŒ ç„¡æ³•æ‰“é–‹G55 G-CODEç”Ÿæˆå™¨é é¢`);
                }
            }, 300);
        }
        
        function copyData() {
            if (!currentCNCData) {
                showError('è«‹å…ˆè¨ˆç®—CNCé»ä½');
                return;
            }
            
            try {
                const dataText = document.getElementById('dataPreview').textContent;
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(dataText).then(() => {
                        showSuccess('âœ… æ•¸æ“šå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
                    }).catch(() => {
                        fallbackCopy(dataText);
                    });
                } else {
                    fallbackCopy(dataText);
                }
            } catch (error) {
                showError('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–ä¸¦è¤‡è£½æ•¸æ“š');
            }
        }
        
        function fallbackCopy(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.top = '-1000px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showSuccess('âœ… æ•¸æ“šå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
                } else {
                    showError('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½');
                }
            } catch (error) {
                showError('âŒ è¤‡è£½å¤±æ•—ï¼š' + error.message);
            }
        }
        
        function showSuccess(message) {
            hideAllMessages();
            const successMsg = document.getElementById('successMsg');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            setTimeout(() => { successMsg.style.display = 'none'; }, 5000);
        }
        
        function showError(message) {
            hideAllMessages();
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            setTimeout(() => { errorMsg.style.display = 'none'; }, 5000);
        }
        
        function hideAllMessages() {
            document.getElementById('successMsg').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
        }
        
        function clearAll() {
            try {
                debugInfo = [];
                currentCNCData = null;
                
                // é‡ç½®è¼¸å…¥æ¬„ä½
                document.getElementById('productName').value = '';
                document.getElementById('topPoint').value = '';
                document.getElementById('bottomPoint').value = '';
                
                document.getElementById('topOffset').value = '9';
                document.getElementById('bottomOffset').value = '4.29';
                document.getElementById('slopeOffset').value = '6';
                document.getElementById('xOffset').value = '60';
                
                // éš±è—çµæœå€åŸŸ
                document.getElementById('resultsSection').style.display = 'none';
                
                // æ¸…é™¤æœ¬åœ°æ•¸æ“š
                localStorage.removeItem('cncCalculatorData');
                localStorage.removeItem('autoImportFlag');
                localStorage.removeItem('autoImportTimestamp');
                localStorage.removeItem('forceAutoImport');
                localStorage.removeItem('selectedVersion');
                
                hideAllMessages();
                showSuccess('âœ… å·²æ¸…é™¤æ‰€æœ‰æ•¸æ“š');
            } catch (error) {
                showError('æ¸…é™¤å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        window.onload = function() {
            try {
                // è¨­ç½®é è¨­å€¼ï¼Œä½¿ç”¨31F-07çš„æ¸¬è©¦æ•¸æ“š
                document.getElementById('productName').value = '31F-07';
                document.getElementById('topPoint').value = 'X-100 Y0.00';
                document.getElementById('bottomPoint').value = 'X-50 Y-50';
                
                addDebugInfo('651 CNCè¨ˆç®—å™¨å·²åˆå§‹åŒ–ï¼Œæº–å‚™å°±ç·’');
                console.log('é é¢è¼‰å…¥å®Œæˆï¼Œæ‰€æœ‰åŠŸèƒ½å·²å°±ç·’');
                
                // åˆå§‹åŒ–ç‰ˆæœ¬è™Ÿæç¤ºåŠŸèƒ½
                initVersionTooltip();
            } catch (error) {
                console.error('é é¢åˆå§‹åŒ–éŒ¯èª¤:', error);
                addDebugInfo(`åˆå§‹åŒ–éŒ¯èª¤: ${error.message}`);
            }
        };
        
        // ç‰ˆæœ¬è™Ÿæç¤ºåŠŸèƒ½åˆå§‹åŒ–
        function initVersionTooltip() {
            const versionBadge = document.querySelector('.version-badge');
            const versionTooltip = document.getElementById('versionTooltip');
            
            let tooltipTimeout;
            let isTooltipVisible = false;
            
            // æ‡¸åœé¡¯ç¤ºæç¤ºæ¡†
            versionBadge.addEventListener('mouseenter', function() {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = setTimeout(() => {
                    if (!isTooltipVisible) {
                        versionTooltip.classList.add('show');
                        isTooltipVisible = true;
                    }
                }, 300); // 300mså»¶é²é˜²æ­¢èª¤è§¸
            });
            
            // é›¢é–‹éš±è—æç¤ºæ¡†
            versionBadge.addEventListener('mouseleave', function() {
                clearTimeout(tooltipTimeout);
                setTimeout(() => {
                    versionTooltip.classList.remove('show');
                    isTooltipVisible = false;
                }, 100);
            });
            
            console.log('ç‰ˆæœ¬è™Ÿæç¤ºåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        }
        
        // å¾€ä¸ŠæŒ‰éˆ•åŠŸèƒ½
        function scrollToCoordinateInput() {
            const coordinateSection = document.getElementById('coordinateInput');
            if (coordinateSection) {
                coordinateSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }
        
        // ç›£è½æ»¾å‹•äº‹ä»¶ï¼Œæ§åˆ¶å¾€ä¸ŠæŒ‰éˆ•çš„é¡¯ç¤º/éš±è—
        window.addEventListener('scroll', function() {
            const scrollUpBtn = document.getElementById('scrollUpBtn');
            const coordinateSection = document.getElementById('coordinateInput');
            
            if (coordinateSection && scrollUpBtn) {
                const coordinateSectionBottom = coordinateSection.offsetTop + coordinateSection.offsetHeight;
                const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                
                // ç•¶æ»¾å‹•è¶…éç«¯é»åº§æ¨™è¼¸å…¥å€åŸŸåº•éƒ¨æ™‚é¡¯ç¤ºæŒ‰éˆ•
                if (scrollPosition > coordinateSectionBottom + 100) {
                    scrollUpBtn.classList.add('show');
                } else {
                    scrollUpBtn.classList.remove('show');
                }
            }
        });
    </script>
</body>
</html>