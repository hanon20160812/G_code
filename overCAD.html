<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overè£ç”² - CNCé‘½å­”ä»£ç¢¼ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #FFE4E1 0%, #FFF0F5 50%, #FFEBCD 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(255, 228, 225, 0.3);
            border: 2px solid rgba(255, 192, 203, 0.4);
            overflow: hidden;
        }

        .panel-cad-import {
            height: 850px;
            display: flex;
            flex-direction: column;
        }

        .panel-cad-import .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-cnc-generation {
            height: 850px;
            display: flex;
            flex-direction: column;
        }

        .panel-cnc-generation .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-output-result {
            height: 850px;
            display: flex;
            flex-direction: column;
        }

        .panel-output-result .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(45deg, #F0E68C, #FFE4B5);
            color: #8B4513;
            padding: 20px;
            text-align: center;
        }

        .header h2 {
            font-size: 2.0em;
            margin-bottom: 10px;
        }

        .content {
            padding: 20px;
            
        }

        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 15px;
            padding: 10px;
            background: #F0F8FF;
            border-radius: 8px;
            border-left: 4px solid #DDA0DD;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #8B4513;
            margin-bottom: 0;
            font-size: 16px;
            min-width: 120px;
            flex-shrink: 0;
        }

        .form-group.vertical {
            flex-direction: column;
            align-items: stretch;
        }

        .form-group.vertical label {
            margin-bottom: 5px;
            min-width: auto;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #F5DEB3;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #DDA0DD;
            box-shadow: 0 0 0 3px rgba(221, 160, 221, 0.2);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px;
            background: #F8F8FF;
            border-radius: 6px;
            border: 1px solid #DDA0DD;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .checkbox-item:hover {
            background: #E6E6FA;
            border-color: #9370DB;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(147, 112, 219, 0.2);
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            pointer-events: none;
        }

        .btn {
            background: rgba(255, 255, 255, 0.9);
            color: #8B4513;
            border: 2px solid #DDA0DD;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #DDA0DD;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(221, 160, 221, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #8B4513;
            border: 2px solid #9370DB;
        }

        .btn-secondary:hover {
            background: #9370DB;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: white;
            border: 2px solid #FF6B6B;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #FF5252, #FF7A7A);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

       
        .output-area {
            background: white;
            border: 2px solid #F5DEB3;
            border-radius: 10px;
            padding: 15px;
            min-height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            white-space: pre-wrap;
            overflow-y: auto;
            line-height: 1.5;
            flex: 1;
        }

        .output-area .highlight-green {
            background-color: #90EE90;
            padding: 1px 3px;
            border-radius: 3px;
        }

        .output-area .coordinate-box {
            background-color: #FFE4E1;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }

        .import-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: nowrap;
            justify-content: space-between;
        }

        .import-controls .btn {
            flex: 1;
            white-space: nowrap;
            padding: 10px 8px;
            font-size: 14px;
            min-width: 0;
        }

        .status-display {
            background: #F8F8FF;
            border: 1px solid #DDA0DD;
            border-radius: 6px;
            padding: 10px;
            font-size: 16px;
            color: #8B4513;
            margin: 10px 0;
        }

        .coordinate-preview {
            overflow-y: auto;
            background: #FFFEF7;
            border: 1px solid #F0E68C;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            
            min-height: 200px;
        }

        .coordinate-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .coordinate-item:nth-child(even) {
            background: rgba(240, 230, 140, 0.1);
        }

        .cad-import-section {
            background: linear-gradient(135deg, #E6E6FA, #F0F8FF);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #DDA0DD;
        }

        .sample-data {
            background: #FFFEF7;
            border: 1px solid #F0E68C;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .stats-display {
            background: #F0F8FF;
            border: 1px solid #DDA0DD;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 16px;
            color: #8B4513;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 2px 0;
        }

        .diameter-group {
            background: white;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #F0E68C;
        }

        .diameter-header {
            color: #8B4513;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            border-bottom: 1px solid #F0E68C;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diameter-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .sort-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #DDA0DD;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
            color: #8B4513;
            transition: all 0.3s ease;
        }

        .sort-btn:hover {
            background: #DDA0DD;
            color: white;
        }

        .copy-icon {
            color: #8B4513;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
            transition: all 0.3s ease;
            padding: 4px;
            border-radius: 4px;
        }

        .copy-icon:hover {
            opacity: 1;
            background-color: rgba(139, 69, 19, 0.1);
            transform: scale(1.1);
        }

        .copy-tooltip {
            position: relative;
        }

        .copy-tooltip .tooltip-text {
            visibility: hidden;
            background-color: #8B4513;
            color: white;
            text-align: center;
            border-radius: 4px;
            padding: 5px 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            right: 0;
            font-size: 12px;
            font-weight: normal;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .copy-tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            right: 10px;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #8B4513 transparent transparent transparent;
        }

        .copy-tooltip.show .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .coordinate-line {
            margin: 2px 0;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 27px;
        }

        .coordinate-line:hover {
            background: rgba(221, 160, 221, 0.2);
        }

        .coordinate-mapping {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: rgba(255, 248, 220, 0.8);
            border-radius: 6px;
            margin: 8px 0;
            border: 1px dashed #DDA0DD;
        }

        .program-select {
            background: white;
            border: 1px solid #DDA0DD;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
            color: #8B4513;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .program-select:hover {
            border-color: #9370DB;
            background: #F8F8FF;
        }

        .program-select:focus {
            outline: none;
            border-color: #9370DB;
            box-shadow: 0 0 0 2px rgba(147, 112, 219, 0.2);
        }

        .mapping-btn {
            background: linear-gradient(45deg, #90EE90, #98FB98);
            color: #006400;
            border: 1px solid #90EE90;
            font-weight: bold;
            padding: 4px 12px;
        }

        .mapping-btn:hover {
            background: linear-gradient(45deg, #7CFC00, #90EE90);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(144, 238, 144, 0.4);
        }

        .dynamic-fieldset {
            background: #F0F8FF;
            border: 2px solid #DDA0DD;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            animation: fadeIn 0.3s ease-in;
        }

        #dynamicFieldsetArea {

            overflow-y: auto;
            margin: 15px 0;
            padding-right: 5px;
        }

        .fieldset-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 1fr;
                max-width: 1200px;
            }
            
            .import-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .import-controls .btn {
                flex: 0 1 auto;
                min-width: 120px;
            }
        }

        @media (min-width: 1401px) and (max-width: 1600px) {
            .container {
                grid-template-columns: 1fr 1fr;
                max-width: 1400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦å´ï¼šåº§æ¨™å°å…¥èˆ‡é è¦½ -->
        <div class="panel panel-cad-import">
            <div class="header">
                <h2>ğŸ¯ CADåº§æ¨™å°å…¥</h2>
                <p>å¾AutoCADæå–åœ“å½¢åº§æ¨™æ•¸æ“šï¼Œæ”¯æ´å¤šç¨®æ ¼å¼å’Œæ’åºåŠŸèƒ½</p>
            </div>
            <div class="content">
                <!-- CADæ•¸æ“šå°å…¥æ§åˆ¶å€åŸŸ -->
                <div class="cad-import-section">
                <div class="import-controls">
                    <button class="btn btn-secondary" onclick="importFromClipboard()">ğŸ“‹ ç›´æ¥è²¼ä¸Š</button>
                        <button class="btn btn-secondary" onclick="importFromURL()">ğŸ”— å¾CADå°å…¥</button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">ğŸ“ è¼‰å…¥ç¯„ä¾‹</button>
                        <button class="btn btn-secondary" onclick="clearCoordinates()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
                </div>
                <div class="status-display" id="importStatus">ç­‰å¾…CADæ•¸æ“šå°å…¥...</div>
                </div>
                
                <!-- åº§æ¨™é è¦½ -->
                <div class="section-title">ğŸ“Š åº§æ¨™é è¦½</div>
                <div class="coordinate-preview" id="coordinatePreview">
                    <div style="text-align: center; color: #999;">å°šæœªå°å…¥åº§æ¨™æ•¸æ“š</div>
                </div>
                
                <!-- è¼¸å…¥è³‡æ–™å€åŸŸ -->
                <div class="section-title">ğŸ“ è¼¸å…¥è³‡æ–™</div>
                
                <div class="form-group vertical">
                    <label for="inputData">åº§æ¨™æ•¸æ“šï¼š</label>
                    <textarea id="inputData" rows="6" placeholder="ç¯„ä¾‹æ ¼å¼ï¼š
Xåº§æ¨™	Yåº§æ¨™	åœ“å¤§å°
72	-44.37	10
332	150	10
632	-44.37	6"></textarea>
                </div>
                
                <div style="text-align: center; margin: 15px 0;">
                    <button class="btn" onclick="convertAndProcessData()" style="font-size: 16px; padding: 12px 25px;">
                        ğŸ”„ è½‰æ›ä¸¦æ’åº
                    </button>
                </div>
                
                <!-- çµ±è¨ˆè³‡è¨Š -->
                <div class="stats-display" id="coordinateStats" style="display: none;">
                    <div class="section-title" style="margin-bottom: 10px;">ğŸ“Š çµ±è¨ˆè³‡è¨Š</div>
                    <div class="stats-item">
                        <span><strong>ç¸½åº§æ¨™æ•¸é‡:</strong></span>
                        <span id="totalCoords">0</span>
                    </div>
                    <div class="stats-item">
                        <span><strong>ç›´å¾‘ç¨®é¡:</strong></span>
                        <span id="diameterCount">0</span>
                    </div>
                    <div id="diameterBreakdown"></div>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šCNCä»£ç¢¼ç”Ÿæˆ -->
        <div class="panel panel-cnc-generation">
            <div class="header">
                <h2>âš™ï¸ CNCä»£ç¢¼ç”Ÿæˆ</h2>
                <p>ç”Ÿæˆé‘½å­”G-CODEç¨‹å¼</p>
            </div>
            <div class="content">
                <div class="section-title">ğŸ”§ å·¥ä»¶è³‡æ–™</div>
                
                <div class="form-group">
                    <label for="model">å‹è™Ÿï¼š</label>
                    <input type="text" id="model" placeholder="è¼¸å…¥å·¥ä»¶å‹è™Ÿ">
                </div>

                <div class="form-group">
                    <label for="length">é•·åº¦ï¼š</label>
                    <input type="number" id="length" placeholder="åªè¦è¼¸å…¥æ•¸å­—å³å¯">
                </div>

                <div class="form-group">
                    <label for="origin">å·¥ä»¶åŸé»ï¼š</label>
                    <select id="origin">
                        <option value="left-top">å·¦ä¸Š</option>
                        <option value="left-bottom">å·¦ä¸‹</option>
                        <option value="right-top">å³ä¸Š</option>
                        <option value="right-bottom">å³ä¸‹</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="coordinateG">åæ¨™ç³»Gï¼š</label>
                    <select id="coordinateG">
                        <option value="G54">G54</option>
                        <option value="G55">G55</option>
                        <option value="G56">G56</option>
                        <option value="G57">G57</option>
                        <option value="G58">G58</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="programEndX">çµæŸä½ç½®Xï¼š</label>
                    <input type="text" id="programEndX" name="programEndX" placeholder="è¼¸å…¥ç¨‹å¼çµæŸä½ç½®X" value="(G0G90X-100.)">
                </div>

                <div class="section-title">ğŸ“ ç¨‹å¼æ®µé¸æ“‡</div>
                <div class="checkbox-group">
                    <div class="checkbox-item" onclick="toggleCheckbox('N1')">
                        <input type="checkbox" id="N1" value="N1" onchange="toggleProgramSection('N1')">
                        <label for="N1">N1</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('N2')">
                        <input type="checkbox" id="N2" value="N2" onchange="toggleProgramSection('N2')">
                        <label for="N2">N2</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('N3')">
                        <input type="checkbox" id="N3" value="N3" onchange="toggleProgramSection('N3')">
                        <label for="N3">N3</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('N4')">
                        <input type="checkbox" id="N4" value="N4" onchange="toggleProgramSection('N4')">
                        <label for="N4">N4</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('N5')">
                        <input type="checkbox" id="N5" value="N5" onchange="toggleProgramSection('N5')">
                        <label for="N5">N5</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('N6')">
                        <input type="checkbox" id="N6" value="N6" onchange="toggleProgramSection('N6')">
                        <label for="N6">N6</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('N7')">
                        <input type="checkbox" id="N7" value="N7" onchange="toggleProgramSection('N7')">
                        <label for="N7">N7</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('N8')">
                        <input type="checkbox" id="N8" value="N8" onchange="toggleProgramSection('N8')">
                        <label for="N8">N8</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('N9')">
                        <input type="checkbox" id="N9" value="N9" onchange="toggleProgramSection('N9')">
                        <label for="N9">N9</label>
                    </div>
                    <div class="checkbox-item" onclick="toggleCheckbox('N10')">
                        <input type="checkbox" id="N10" value="N10" onchange="toggleProgramSection('N10')">
                        <label for="N10">N10</label>
                    </div>
                </div>

                <!-- å‹•æ…‹ç¨‹å¼æ®µå€åŸŸ -->
                <div id="dynamicFieldsetArea"></div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="generateGCode()" style="font-size: 18px; padding: 15px 30px;">
                        ç”ŸæˆÎµ(*Â´ï½¥âˆ€ï½¥ï½€)Ğ·ï¾
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰å€‹é¢æ¿ï¼šè¼¸å‡ºçµæœ -->
        <div class="panel panel-output-result">
            <div class="header">
                <h2>ğŸ“¤ è¼¸å‡ºçµæœ</h2>
                <p>G-CODEç¨‹å¼è¼¸å‡ºèˆ‡æª”æ¡ˆæ“ä½œ</p>
            </div>
            <div class="content">
                <div class="section-title">ğŸ“„ G-CODEç¨‹å¼</div>
                                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="copyGCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
                    <button class="btn" onclick="saveGCode()">ğŸ’¾ å„²å­˜æª”æ¡ˆ</button>
                    <a href="https://ncviewer.com/" target="_blank" class="btn" style="text-decoration: none;">ğŸ” CNCæª¢æŸ¥</a>
                </div><br>
                <div class="output-area" id="gcodeOutput">ç­‰å¾…ç”ŸæˆG-CODE...</div>
                

            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let coordinateData = [];
        let processedCoordinates = {};

        // åˆ‡æ›checkboxç‹€æ…‹ï¼ˆé»æ“Šæ•´å€‹å€åŸŸæ™‚ï¼‰
        function toggleCheckbox(programNumber) {
            const checkbox = document.getElementById(programNumber);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                // è§¸ç™¼onchangeäº‹ä»¶
                checkbox.dispatchEvent(new Event('change'));
            }
        }

        // å‹•æ…‹ç¨‹å¼æ®µåˆ‡æ›
        function toggleProgramSection(programNumber) {
            console.log('toggleProgramSection è¢«èª¿ç”¨, programNumber:', programNumber);
            try {
            const checkbox = document.getElementById(programNumber);
            const dynamicArea = document.getElementById('dynamicFieldsetArea');
            const existingFieldset = document.getElementById(`fieldset_${programNumber}`);
            
                console.log('checkbox:', checkbox);
                console.log('checkbox.checked:', checkbox ? checkbox.checked : 'checkboxä¸å­˜åœ¨');
                console.log('dynamicArea:', dynamicArea);
                console.log('existingFieldset:', existingFieldset);
                
                if (checkbox && checkbox.checked && !existingFieldset) {
                // å‰µå»ºæ–°çš„fieldset
                    console.log('å‰µå»ºæ–°çš„ç¨‹å¼æ®µ:', programNumber);
                createProgramFieldset(programNumber);
                updateImportStatus(`âœ… å·²æ·»åŠ  ${programNumber} ç¨‹å¼æ®µè¨­å®š`, 'success');
                } else if (checkbox && !checkbox.checked && existingFieldset) {
                // ç§»é™¤fieldset
                    console.log('ç§»é™¤ç¨‹å¼æ®µ:', programNumber);
                existingFieldset.remove();
                updateImportStatus(`ğŸ—‘ï¸ å·²ç§»é™¤ ${programNumber} ç¨‹å¼æ®µè¨­å®š`, 'info');
                } else {
                    console.log('æ²’æœ‰åŸ·è¡Œä»»ä½•å‹•ä½œ');
                }
            } catch (error) {
                console.error('toggleProgramSection éŒ¯èª¤:', error);
                updateImportStatus(`âŒ ç¨‹å¼æ®µåˆ‡æ›å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // åˆ€å…·é¡å‹æ•¸æ“šå°è±¡
        const toolTypeData = {
            "6mm mill": { spindleSpeed: "2650", feedSpeed: "40" },
            "12mm mill": { spindleSpeed: "1280", feedSpeed: "120" },
            "6mm drill": { spindleSpeed: "3200", feedSpeed: "200" },
            "13mm drill": { spindleSpeed: "1600", feedSpeed: "100" },
            "22mm drill": { spindleSpeed: "3200", feedSpeed: "125" },
            "26mm drill": { spindleSpeed: "3200", feedSpeed: "150" },
            "3mm drill": { spindleSpeed: "4000", feedSpeed: "150" },
            "4mm drill": { spindleSpeed: "3500", feedSpeed: "180" },
            "5mm drill": { spindleSpeed: "3000", feedSpeed: "200" },
            "8mm drill": { spindleSpeed: "2800", feedSpeed: "180" },
            "10mm drill": { spindleSpeed: "2400", feedSpeed: "160" },
            "12mm drill": { spindleSpeed: "2000", feedSpeed: "140" },
            "16mm drill": { spindleSpeed: "1800", feedSpeed: "120" },
            "20mm drill": { spindleSpeed: "1600", feedSpeed: "100" },
            "25mm drill": { spindleSpeed: "1400", feedSpeed: "90" },
            "30mm drill": { spindleSpeed: "1200", feedSpeed: "80" }
        };

        // å‰µå»ºç¨‹å¼æ®µè¡¨å–®
        function createProgramFieldset(programNumber) {
            console.log('createProgramFieldset è¢«èª¿ç”¨, programNumber:', programNumber);
            try {
            const dynamicArea = document.getElementById('dynamicFieldsetArea');
                
                if (!dynamicArea) {
                    console.error('æ‰¾ä¸åˆ° dynamicFieldsetArea å…ƒç´ ');
                    return;
                }
            
            // å‰µå»ºfieldsetå®¹å™¨
            const fieldset = document.createElement('div');
            fieldset.className = 'dynamic-fieldset';
            fieldset.id = `fieldset_${programNumber}`;
            
                console.log('å‰µå»ºçš„fieldsetå…ƒç´ :', fieldset);
                
                // æ ¹æ“šJSæ–‡ä»¶æ ¼å¼ç”Ÿæˆçµ±ä¸€çš„è¡¨å–®
                const formContent = `
                    <div style="background: #DDA0DD; color: white; padding: 5px 15px; border-radius: 5px; font-weight: bold; margin-bottom: 15px;">${programNumber}</div>
                        <div class="fieldset-grid">
                            <div class="form-group">
                            <label for="toolT-${programNumber}">åˆ€åº«Tï¼š</label>
                            <select id="toolT-${programNumber}" name="toolT" onchange="updateToolData('${programNumber}')">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="T1">T1</option>
                                <option value="T2">T2</option>
                                <option value="T3">T3</option>
                                <option value="T4">T4</option>
                                <option value="T5">T5</option>
                                <option value="T6">T6</option>
                                <option value="T7">T7</option>
                                <option value="T8">T8</option>
                                <option value="T9">T9</option>
                                <option value="T10">T10</option>
                                <option value="T11">T11</option>
                                <option value="T12">T12</option>
                            </select>
                            </div>
                            <div class="form-group">
                            <label for="toolRemark-${programNumber}">åˆ€åº«å‚™è¨»ï¼š</label>
                            <select id="toolRemark-${programNumber}" name="toolRemark" onchange="updateToolParameters('${programNumber}')">
                                <option value="">è«‹é¸æ“‡åˆ€å…·é¡å‹</option>
                                <optgroup label="éŠ‘åˆ€ (Mill)">
                                    <option value="6mm mill">6mm mill</option>
                                    <option value="12mm mill">12mm mill</option>
                                </optgroup>
                                <optgroup label="é‘½é ­ (Drill)">
                                    <option value="3mm drill">3mm drill</option>
                                    <option value="4mm drill">4mm drill</option>
                                    <option value="5mm drill">5mm drill</option>
                                    <option value="6mm drill">6mm drill</option>
                                    <option value="8mm drill">8mm drill</option>
                                    <option value="10mm drill">10mm drill</option>
                                    <option value="12mm drill">12mm drill</option>
                                    <option value="13mm drill">13mm drill</option>
                                    <option value="16mm drill">16mm drill</option>
                                    <option value="20mm drill">20mm drill</option>
                                    <option value="22mm drill">22mm drill</option>
                                    <option value="25mm drill">25mm drill</option>
                                    <option value="26mm drill">26mm drill</option>
                                    <option value="30mm drill">30mm drill</option>
                                </optgroup>
                            </select>
                            </div>
                            <div class="form-group">
                            <label for="coordinateXY-${programNumber}">ç¬¬ä¸€åº§æ¨™ï¼š</label>
                            <input type="text" id="coordinateXY-${programNumber}" name="coordinateXY">
                            </div>
                            <div class="form-group">
                            <label for="coordinates-${programNumber}">åº§æ¨™å€‘ï¼š</label>
                            <textarea id="coordinates-${programNumber}" name="coordinates" rows="3" placeholder="(X159.9999 Y-48.8390 ( 22 )ç¯„ä¾‹)"></textarea>
                            </div>
                            <div class="form-group">
                            <label for="spindleSpeed-${programNumber}">ä¸»è»¸è½‰é€ŸSï¼š</label>
                            <input type="text" id="spindleSpeed-${programNumber}" name="spindleSpeed" placeholder="åªè¦è¼¸å…¥æ•¸å­—å³å¯">
                            </div>
                            <div class="form-group">
                            <label for="correctionH-${programNumber}">è£œæ­£Hï¼š</label>
                            <input type="text" id="correctionH-${programNumber}" name="correctionH" value="H1" readonly>
                            </div>
                            <div class="form-group">
                            <label for="drillUpZ-${programNumber}" style="background-color: #CDC1FF">é‘½å­”æŠ¬åˆ€Zï¼š</label>
                            <input type="number" id="drillUpZ-${programNumber}" name="drillUpZ" placeholder="åªè¦è¼¸å…¥æ•¸å­—å³å¯" value="60">
                            </div>
                            <div class="form-group">
                            <label for="depthZ-${programNumber}" style="background-color: #84C1FF">é‘½å­”æ·±åº¦Zï¼š</label>
                            <input type="number" id="depthZ-${programNumber}" name="depthZ" placeholder="åªè¦è¼¸å…¥æ•¸å­—å³å¯" min="-150" max="300" value="-10" oninput="validateDepthZ(this)">
                            </div>
                            <div class="form-group">
                            <label for="drillHeightR-${programNumber}">é‘½å­”é«˜åº¦Rï¼š</label>
                            <input type="number" id="drillHeightR-${programNumber}" name="drillHeightR" placeholder="åªè¦è¼¸å…¥æ•¸å­—å³å¯" value="10">
                            </div>
                            <div class="form-group">
                            <label for="feedSpeedF-${programNumber}">é€²çµ¦é€Ÿåº¦Fï¼š</label>
                            <input type="text" id="feedSpeedF-${programNumber}" name="feedSpeedF" placeholder="åªè¦è¼¸å…¥æ•¸å­—å³å¯">
                            </div>
                            <div class="form-group">
                            <label for="endUpZ-${programNumber}" style="background-color: #FFB0B0">çµæŸæåˆ€Zï¼š</label>
                            <input type="number" id="endUpZ-${programNumber}" name="endUpZ" placeholder="åªè¦è¼¸å…¥æ•¸å­—å³å¯" value="100">
                            </div>
                            <div class="form-group">
                            <label for="isHighest-${programNumber}">æ˜¯å¦è‡³æœ€é«˜ï¼š</label>
                            <select id="isHighest-${programNumber}" name="isHighest">
                                <option value="G91G28Z0">YES</option>
                                <option value="" selected>NO</option>
                                </select>
                            </div>
                        </div>
                    `;
                
                fieldset.innerHTML = formContent;
                dynamicArea.appendChild(fieldset);
                console.log('ç¨‹å¼æ®µè¡¨å–®å·²æ·»åŠ åˆ°é é¢:', programNumber);
                
            } catch (error) {
                console.error('createProgramFieldset éŒ¯èª¤:', error);
                updateImportStatus(`âŒ å‰µå»ºç¨‹å¼æ®µè¡¨å–®å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ·±åº¦Zé©—è­‰å‡½æ•¸
        window.validateDepthZ = function (input) {
            const value = parseFloat(input.value);

            if (value >= 300) {
                input.value = "300";
                alert("æ·±åº¦Zçš„å€¼ä¸èƒ½é«˜æ–¼300ï¼Œå·²è‡ªå‹•è¨­ç½®ç‚º300");
            } else if (value < -150) {
                input.value = -150;
                alert("æ·±åº¦Zçš„å€¼ä¸èƒ½ä½æ–¼-150ï¼Œå·²è‡ªå‹•è¨­ç½®ç‚º-150");
            }
        };

        // æ›´æ–°åˆ€åº«Tç›¸é—œæ¬„ä½çš„å‡½æ•¸
        window.updateToolData = function (program) {
            const selectedTool = document.getElementById(`toolT-${program}`).value;

            // è£œæ­£Hæ¬„ä½çš„æ›´æ–°ï¼ˆæ ¹æ“šåˆ€åº«Tç·¨è™Ÿï¼‰
            const correctionInput = document.getElementById(`correctionH-${program}`);
            const toolIndex = selectedTool ? parseInt(selectedTool.replace("T", ""), 10) : 1;
            correctionInput.value = `H${toolIndex}`;
        };

        // æ›´æ–°åˆ€å…·åƒæ•¸çš„å‡½æ•¸ï¼ˆæ ¹æ“šåˆ€åº«å‚™è¨»é¸æ“‡ï¼‰
        window.updateToolParameters = function (program) {
            const selectedToolType = document.getElementById(`toolRemark-${program}`).value;

            if (selectedToolType && toolTypeData[selectedToolType]) {
                document.getElementById(`spindleSpeed-${program}`).value = toolTypeData[selectedToolType].spindleSpeed;
                document.getElementById(`feedSpeedF-${program}`).value = toolTypeData[selectedToolType].feedSpeed;
            } else {
                document.getElementById(`spindleSpeed-${program}`).value = "";
                document.getElementById(`feedSpeedF-${program}`).value = "";
            }
        };

        // å¾å‰ªè²¼ç°¿å°å…¥CADæ•¸æ“šï¼ˆå¢å¼·ç‰ˆï¼‰
        async function importFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                
                // å˜—è©¦è§£æJSONæ ¼å¼ï¼ˆä¾†è‡ªLISPç¨‹å¼ï¼‰
                try {
                    const cadData = JSON.parse(text);
                    if (cadData.coordinates && Array.isArray(cadData.coordinates)) {
                        processCADData(cadData);
                        updateImportStatus('âœ… æˆåŠŸå°å…¥CADæ•¸æ“š', 'success');
                        return;
                    }
                } catch (e) {
                    // å¦‚æœä¸æ˜¯JSONï¼Œç•¶ä½œæ™®é€šæ–‡å­—è™•ç†
                }
                
                // è™•ç†æ™®é€šæ–‡å­—æ ¼å¼
                document.getElementById('inputData').value = text;
                updateImportStatus('âœ… å·²å¾å‰ªè²¼ç°¿å°å…¥æ–‡å­—æ•¸æ“š', 'success');
                convertAndProcessData();
                
            } catch (e) {
                updateImportStatus('âŒ å‰ªè²¼ç°¿è®€å–å¤±æ•—: ' + e.message, 'error');
            }
        }

        // å¾URLå°å…¥
        function importFromURL() {
            checkURLParams();
            if (!window.location.search.includes('data=')) {
                updateImportStatus('âš ï¸ URLä¸­æ²’æœ‰æ‰¾åˆ°æ•¸æ“šåƒæ•¸', 'error');
            }
        }

        // æª¢æŸ¥URLåƒæ•¸
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            if (dataParam) {
                try {
                    const cadData = JSON.parse(decodeURIComponent(dataParam));
                    processCADData(cadData);
                    updateImportStatus('âœ… å·²å¾URLè‡ªå‹•å°å…¥CADæ•¸æ“š', 'success');
                } catch (e) {
                    updateImportStatus('âŒ URLæ•¸æ“šè§£æå¤±æ•—: ' + e.message, 'error');
                }
            }
        }

        // è™•ç†CADæ•¸æ“šï¼ˆå¢å¼·ç‰ˆï¼‰
        function processCADData(cadData) {
            console.log('processCADData è¢«èª¿ç”¨, cadData:', cadData);
            try {
                if (!cadData || !cadData.coordinates || !Array.isArray(cadData.coordinates)) {
                    console.error('CADæ•¸æ“šæ ¼å¼ç„¡æ•ˆ:', cadData);
                    updateImportStatus('âŒ CADæ•¸æ“šæ ¼å¼ç„¡æ•ˆ', 'error');
                    return;
                }

                // è½‰æ›CADæ•¸æ“šç‚ºè¡¨æ ¼æ ¼å¼ä¸¦å¡«å…¥è¼¸å…¥æ¡†
                let tableData = 'Xåº§æ¨™\tYåº§æ¨™\tåœ“å¤§å°\n';
                cadData.coordinates.forEach(coord => {
                    tableData += `${coord.x}\t${coord.y}\t${coord.diameter}\n`;
                });
                document.getElementById('inputData').value = tableData;
                
                // è‡ªå‹•è½‰æ›ä¸¦è™•ç†
                convertAndProcessData();
                
                updateImportStatus(`âœ… æˆåŠŸå°å…¥ ${cadData.coordinates.length} å€‹åœ“å½¢åº§æ¨™`, 'success');
                
            } catch (error) {
                console.error('processCADData éŒ¯èª¤:', error);
                updateImportStatus(`âŒ è™•ç†CADæ•¸æ“šå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // è½‰æ›ä¸¦è™•ç†æ•¸æ“šï¼ˆæ–°å¢ä¸»è¦å‡½æ•¸ï¼‰
        function convertAndProcessData() {
            const input = document.getElementById('inputData').value.trim();
            
            if (!input) {
                updateImportStatus('è«‹è¼¸å…¥åº§æ¨™è³‡æ–™', 'error');
                return;
            }
            
            try {
                // è§£æè¼¸å…¥è³‡æ–™
                const lines = input.split('\n').filter(line => line.trim());
                const data = [];
                
                for (let i = 1; i < lines.length; i++) { // è·³éæ¨™é¡Œè¡Œ
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // æ”¯æ´ Tabã€ç©ºæ ¼ã€é€—è™Ÿåˆ†éš”
                    const parts = line.split(/[\s,]+/);
                    
                    if (parts.length >= 3) {
                        const x = parseFloat(parts[0]);
                        const y = parseFloat(parts[1]);
                        const diameter = parseFloat(parts[2]);
                        
                        if (!isNaN(x) && !isNaN(y) && !isNaN(diameter)) {
                            data.push({ x, y, diameter });
                        }
                    }
                }
                
                if (data.length === 0) {
                    updateImportStatus('ç”²è³½æ‹‰ï¼Œæ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åº§æ¨™è³‡æ–™', 'error');
                    return;
                }
                
                // è¨­å®šå…¨åŸŸè®Šæ•¸
                coordinateData = data;
                
                // æŒ‰åœ“å¤§å°åˆ†çµ„
                processedCoordinates = {};
                data.forEach(item => {
                    if (!processedCoordinates[item.diameter]) {
                        processedCoordinates[item.diameter] = [];
                    }
                    processedCoordinates[item.diameter].push(item);
                });
                
                // å°æ¯çµ„å…§çš„è³‡æ–™é€²è¡Œé è¨­æ’åºï¼ˆXè»¸ç”±å°åˆ°å¤§ï¼ŒYè»¸ç”±å°åˆ°å¤§ï¼‰
                Object.keys(processedCoordinates).forEach(diameter => {
                    processedCoordinates[diameter].sort((a, b) => {
                        // å…ˆæŒ‰ X è»¸æ’åºï¼ˆç”±å°åˆ°å¤§ï¼‰
                        const xCompare = a.x - b.x;
                        if (xCompare !== 0) return xCompare;
                        
                        // X ç›¸åŒæ™‚æŒ‰ Y è»¸æ’åºï¼ˆç”±å°åˆ°å¤§ï¼‰
                        return a.y - b.y;
                    });
                });
                
                // æ›´æ–°é¡¯ç¤º
                updateCoordinatePreview();
                updateCoordinateStats();
                
                const sortedDiameters = Object.keys(processedCoordinates).map(Number).sort((a, b) => a - b);
                updateImportStatus(`âœ… æˆåŠŸè½‰æ› ${data.length} ç­†è³‡æ–™ï¼Œå…± ${sortedDiameters.length} å€‹ç›´å¾‘ç¾¤çµ„`, 'success');
                
            } catch (error) {
                console.error('è½‰æ›æ•¸æ“šéŒ¯èª¤:', error);
                updateImportStatus('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼', 'error');
            }
        }

        // æ›´æ–°åº§æ¨™é è¦½ï¼ˆå¢å¼·ç‰ˆï¼‰
        function updateCoordinatePreview() {
            const preview = document.getElementById('coordinatePreview');
            
            // æŒ‰ç›´å¾‘æ’åºï¼ˆé è¨­ç”±å°åˆ°å¤§ï¼‰
            const sortedDiameters = Object.keys(processedCoordinates)
                .map(Number)
                .sort((a, b) => a - b);
            
            let htmlOutput = '';
            
            sortedDiameters.forEach((diameter) => {
                // å‰µå»ºç›´å¾‘ç¾¤çµ„å€å¡Š
                htmlOutput += `<div class="diameter-group">`;
                htmlOutput += `<div class="diameter-header">
                    <span>ğŸ”¸ ç›´å¾‘ ${diameter.toFixed(1)}mm (${processedCoordinates[diameter].length} é»)</span>
                    <div class="diameter-controls">
                        <button class="sort-btn" onclick="sortDiameterGroup(${diameter}, 'x-asc')" title="Xè»¸ç”±å°åˆ°å¤§">Xâ†—</button>
                        <button class="sort-btn" onclick="sortDiameterGroup(${diameter}, 'x-desc')" title="Xè»¸ç”±å¤§åˆ°å°">Xâ†˜</button>
                        <button class="sort-btn" onclick="sortDiameterGroup(${diameter}, 'y-asc')" title="Yè»¸ç”±å°åˆ°å¤§">Yâ†—</button>
                        <button class="sort-btn" onclick="sortDiameterGroup(${diameter}, 'y-desc')" title="Yè»¸ç”±å¤§åˆ°å°">Yâ†˜</button>
                        <div class="copy-tooltip">
                            <span class="copy-icon" onclick="copyDiameterGroup(${diameter})" title="è¤‡è£½æ­¤ç¾¤çµ„åº§æ¨™">ğŸ“‹</span>
                            <span class="tooltip-text">å·²è¤‡è£½ï¼</span>
                        </div>
                    </div>
                </div>
                <div class="coordinate-mapping">
                    <select id="programSelect-${diameter}" class="program-select">
                        <option value="">é¸æ“‡ç¨‹å¼æ®µ</option>
                        <option value="N1">N1</option>
                        <option value="N2">N2</option>
                        <option value="N3">N3</option>
                        <option value="N4">N4</option>
                        <option value="N5">N5</option>
                        <option value="N6">N6</option>
                        <option value="N7">N7</option>
                        <option value="N8">N8</option>
                        <option value="N9">N9</option>
                        <option value="N10">N10</option>
                    </select>
                    <button class="sort-btn mapping-btn" onclick="mapCoordinatesToProgram(${diameter})" title="å°æ¥åˆ°é¸æ“‡çš„ç¨‹å¼æ®µ">ğŸ”— å°æ¥</button>
                </div>`;
                
                // æ·»åŠ åº§æ¨™è³‡æ–™
                processedCoordinates[diameter].forEach((item, index) => {
                    const x = item.x.toFixed(2);
                    const y = item.y.toFixed(2);
                    const size = item.diameter.toFixed(1);
                    
                    const line = `${index + 1}. X${x} Y${y} (Ã˜${size}mm)`;
                    htmlOutput += `<div class="coordinate-line">${line}</div>`;
                });
                
                htmlOutput += '</div>';
            });
            
            preview.innerHTML = htmlOutput;
        }

        // æ’åºç‰¹å®šç›´å¾‘ç¾¤çµ„
        function sortDiameterGroup(diameter, sortType) {
            if (!processedCoordinates[diameter]) return;
            
            const coords = processedCoordinates[diameter];
            
            switch(sortType) {
                case 'x-asc':
                    coords.sort((a, b) => a.x - b.x);
                    break;
                case 'x-desc':
                    coords.sort((a, b) => b.x - a.x);
                    break;
                case 'y-asc':
                    coords.sort((a, b) => a.y - b.y);
                    break;
                case 'y-desc':
                    coords.sort((a, b) => b.y - a.y);
                    break;
            }
            
            // é‡æ–°æ¸²æŸ“é è¦½
            updateCoordinatePreview();
            
            const sortTypeText = {
                'x-asc': 'Xè»¸ç”±å°åˆ°å¤§',
                'x-desc': 'Xè»¸ç”±å¤§åˆ°å°',
                'y-asc': 'Yè»¸ç”±å°åˆ°å¤§',
                'y-desc': 'Yè»¸ç”±å¤§åˆ°å°'
            };
            
            updateImportStatus(`âœ… ç›´å¾‘ ${diameter.toFixed(1)}mm ç¾¤çµ„å·²æŒ‰ ${sortTypeText[sortType]} æ’åº`, 'success');
        }

                // æ›´æ–°çµ±è¨ˆè³‡è¨Šï¼ˆå¢å¼·ç‰ˆï¼‰
        function updateCoordinateStats() {
            const totalCount = document.getElementById('totalCoords');
            const diameterTypes = document.getElementById('diameterCount');
            const diameterBreakdown = document.getElementById('diameterBreakdown');
            
            if (!coordinateData || coordinateData.length === 0) {
                document.getElementById('coordinateStats').style.display = 'none';
                return;
            }
            
            // é è¨­æŒ‰ç›´å¾‘ç”±å°åˆ°å¤§æ’åº
            const sortedDiameters = Object.keys(processedCoordinates)
                .map(Number)
                .sort((a, b) => a - b);
            
            totalCount.textContent = coordinateData.length;
            diameterTypes.textContent = sortedDiameters.length;
            
            // ç”Ÿæˆç›´å¾‘åˆ†ä½ˆè©³æƒ…
            let breakdownHTML = '';
            sortedDiameters.forEach(diameter => {
                const count = processedCoordinates[diameter].length;
                const percentage = ((count / coordinateData.length) * 100).toFixed(1);
                breakdownHTML += `
                    <div class="stats-item">
                        <span>â€¢ Ã˜${diameter.toFixed(1)}mm:</span>
                        <span>${count} é» (${percentage}%)</span>
                    </div>
                `;
            });
            
            diameterBreakdown.innerHTML = breakdownHTML;
            document.getElementById('coordinateStats').style.display = 'block';
        }

        // è¤‡è£½ç‰¹å®šç›´å¾‘ç¾¤çµ„çš„åº§æ¨™æ•¸æ“š
        function copyDiameterGroup(diameter) {
            if (!processedCoordinates[diameter] || processedCoordinates[diameter].length === 0) {
                updateImportStatus('âŒ æ²’æœ‰æ‰¾åˆ°è©²ç›´å¾‘çš„åº§æ¨™æ•¸æ“š', 'error');
                return;
            }
            
            // ç”Ÿæˆè¦è¤‡è£½çš„æ–‡å­—å…§å®¹ï¼ˆåªåŒ…å«åº§æ¨™æ•¸æ“šï¼‰
            let copyText = '';
            
            processedCoordinates[diameter].forEach((item, index) => {
                const x = item.x.toFixed(2);
                const y = item.y.toFixed(2);
                copyText += `X${x} Y${y} (${item.diameter.toFixed(1)})`;
                // æœ€å¾Œä¸€è¡Œä¸åŠ æ›è¡Œç¬¦
                if (index < processedCoordinates[diameter].length - 1) {
                    copyText += '\n';
                }
            });
            
            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            navigator.clipboard.writeText(copyText).then(() => {
                // é¡¯ç¤ºè¤‡è£½æˆåŠŸæç¤º
                showCopyTooltip(diameter);
                updateImportStatus(`âœ… å·²è¤‡è£½ç›´å¾‘ ${diameter.toFixed(1)}mm çš„ ${processedCoordinates[diameter].length} å€‹åº§æ¨™`, 'success');
            }).catch(() => {
                // é™ç´šè™•ç†
                const textArea = document.createElement('textarea');
                textArea.value = copyText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showCopyTooltip(diameter);
                updateImportStatus(`âœ… å·²è¤‡è£½ç›´å¾‘ ${diameter.toFixed(1)}mm çš„ ${processedCoordinates[diameter].length} å€‹åº§æ¨™`, 'success');
            });
        }

        // é¡¯ç¤ºè¤‡è£½æˆåŠŸæç¤º
        function showCopyTooltip(diameter) {
            // æ‰¾åˆ°å°æ‡‰çš„æç¤ºå…ƒç´ 
            const tooltips = document.querySelectorAll('.copy-tooltip');
            tooltips.forEach(tooltip => {
                const copyIcon = tooltip.querySelector('.copy-icon');
                if (copyIcon && copyIcon.getAttribute('onclick').includes(diameter)) {
                    tooltip.classList.add('show');
                    
                    // 2ç§’å¾Œéš±è—æç¤º
                    setTimeout(() => {
                        tooltip.classList.remove('show');
                    }, 2000);
                }
            });
        }



        // å·¥ä»¶åŸé»æ˜ å°„
        const originMapping = {
            'left-top': '(O--------)\n(---------)',
            'left-bottom': '(---------)\n(O--------)',
            'right-top': '(--------O)\n(---------)',
            'right-bottom': '(---------)\n(--------O)'
        };

        // ç”ŸæˆG-CODEï¼ˆåŸºæ–¼JSæ–‡ä»¶æ ¼å¼ï¼‰
        function generateGCode() {
            // ç²å–åŸºæœ¬åƒæ•¸
            const model = document.getElementById('model').value || 'UNKNOWN';
            const length = document.getElementById('length').value || '0';
            const originSelect = document.getElementById('origin');
            const originValue = originSelect.value;
            const origin = originMapping[originValue] || '';
            const coordinateG = document.getElementById('coordinateG').value;
            const programEndX = document.getElementById('programEndX').value || '(G0G90X-100.)';
            
            // æª¢æŸ¥é¸ä¸­çš„ç¨‹å¼æ®µ
            const selectedPrograms = [];
            for (let i = 1; i <= 10; i++) {
                if (document.getElementById(`N${i}`).checked) {
                    selectedPrograms.push(`N${i}`);
                }
            }
            
            // å¦‚æœæ²’æœ‰é¸æ“‡ç¨‹å¼æ®µï¼Œä½¿ç”¨ç›´å¾‘åˆ†çµ„æ¨¡å¼
            if (selectedPrograms.length === 0) {
                generateSimpleGCode();
                return;
            }
            
            // ç”Ÿæˆåˆ€å…·ä¿¡æ¯å’Œä»£ç¢¼
            let toolInfo = '';
            let code = `(${model})\n(L=${length})\n(!!!!!!${coordinateG}!!!!)\n${origin}\n`;
            
            // éæ­·é¸ä¸­çš„ç¨‹å¼æ®µ
            selectedPrograms.forEach((program) => {
                const fieldset = document.getElementById(`fieldset_${program}`);
                if (!fieldset) return;
                
                const toolT = document.getElementById(`toolT-${program}`)?.value || '';
                const coordinateXY = document.getElementById(`coordinateXY-${program}`)?.value || '';
                const coordinates = document.getElementById(`coordinates-${program}`)?.value || '';
                const spindleSpeed = document.getElementById(`spindleSpeed-${program}`)?.value || '';
                const correctionH = document.getElementById(`correctionH-${program}`)?.value || 'H1';
                const feedSpeedF = document.getElementById(`feedSpeedF-${program}`)?.value || '';
                const toolRemark = document.getElementById(`toolRemark-${program}`)?.value || '';
                const depthZ = document.getElementById(`depthZ-${program}`)?.value || '-10';
                const drillUpZ = document.getElementById(`drillUpZ-${program}`)?.value || '60';
                const drillHeightR = document.getElementById(`drillHeightR-${program}`)?.value || '10';
                const endUpZ = document.getElementById(`endUpZ-${program}`)?.value || '100';
                const isHighest = document.getElementById(`isHighest-${program}`)?.value || '';
                
                // æ·»åŠ åˆ€å…·ä¿¡æ¯
                toolInfo += `(${toolRemark}, ${toolT} ${correctionH} S${spindleSpeed} F${feedSpeedF})\n`;
                
                                 // æ·»åŠ ç¨‹å¼æ®µä»£ç¢¼
                 code += `
(<span style="color: #8B4513;">${toolRemark}</span>, <span style="background-color: #FFD09B">${toolT} ${correctionH}</span> S${spindleSpeed} F${feedSpeedF})

${program}
<span style="background-color: #FFD09B">${toolT}</span>(${toolRemark})
G0G90<span class="highlight-green">${coordinateG}</span><span class="coordinate-box">${coordinateXY}</span>(!!) M3S${spindleSpeed}
G43<span style="background-color: #FFD09B">${correctionH}</span>Z100.
<span style="background-color: #CDC1FF">Z${drillUpZ}.</span>M8
G98G81<span style="background-color: #84C1FF">Z${depthZ}.</span>R${drillHeightR}.F${feedSpeedF}

(EX: X159.9999 Y-48.8390)(22)
(!!) 
${coordinates} 

G0G90<span style="background-color: #FFB0B0">Z${endUpZ}.</span>M9
M5
${isHighest}

  
`;
            });
            
            // å°‡åˆ€å…·ä¿¡æ¯æ·»åŠ åˆ°ä»£ç¢¼é–‹é ­
            code = `${toolInfo}\n${code}`;
            
            // æœ€å¾Œè¿½åŠ çµå°¾ç¨‹å¼ç¢¼
            code += `
(~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~)
${programEndX}
M30
`;
            
            // é¡¯ç¤ºçµæœï¼ˆä½¿ç”¨innerHTMLä»¥æ”¯æŒHTMLæ ¼å¼ï¼‰
            const resultElement = document.getElementById('gcodeOutput');
            resultElement.innerHTML = code;
            updateImportStatus('âœ… G-CODEç”Ÿæˆå®Œæˆ', 'success');
            
            // æ»¾å‹•åˆ°è¼¸å‡ºçµæœå€åŸŸ
            setTimeout(() => {
                resultElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // ç”Ÿæˆç°¡å–®G-CODEï¼ˆæŒ‰CADåº§æ¨™ç›´å¾‘åˆ†çµ„ï¼‰
        function generateSimpleGCode() {
            // æª¢æŸ¥æ˜¯å¦æœ‰åº§æ¨™æ•¸æ“š
            if (!coordinateData || coordinateData.length === 0) {
                updateImportStatus('âŒ è«‹å…ˆå°å…¥CADåº§æ¨™æ•¸æ“šæˆ–é¸æ“‡ç¨‹å¼æ®µ', 'error');
                return;
            }
            
            const model = document.getElementById('model').value || 'UNKNOWN';
            const length = document.getElementById('length').value || '0';
            const originSelect = document.getElementById('origin');
            const originValue = originSelect.value;
            const origin = originMapping[originValue] || '';
            const coordinateG = document.getElementById('coordinateG').value;
            const programEndX = document.getElementById('programEndX').value || '(G0G90X-100.)';
            
            let toolInfo = '';
            let code = `(${model})\n(L=${length})\n(!!!!!!${coordinateG}!!!!!!)\n${origin}\n`;
            
            // æŒ‰ç›´å¾‘åˆ†çµ„ç”Ÿæˆä»£ç¢¼ï¼ˆé è¨­ç”±å°åˆ°å¤§ï¼‰
            const sortedDiameters = Object.keys(processedCoordinates)
                .map(Number)
                .sort((a, b) => a - b);
            
            sortedDiameters.forEach((diameter, groupIndex) => {
                const coords = processedCoordinates[diameter];
                // ä½¿ç”¨é è¨­åƒæ•¸å€¼
                const feed = '100';
                const spindle = '3000';
                const depth = '-5';
                const safeZ = '5';
                
                const toolT = `T${groupIndex + 1}`;
                const correctionH = `H${groupIndex + 1}`;
                const toolRemark = `${diameter}mm drill`;
                
                // æ·»åŠ åˆ€å…·ä¿¡æ¯
                toolInfo += `(${toolRemark}, ${toolT} ${correctionH} S${spindle} F${feed})\n`;
                
                // æ·»åŠ ç¨‹å¼æ®µä»£ç¢¼
                code += `
(${toolRemark}, ${toolT} ${correctionH} S${spindle} F${feed})

AUTO_${diameter}MM
${toolT}(${toolRemark})
G0G90${coordinateG}X${coords[0].x.toFixed(3)}Y${coords[0].y.toFixed(3)}(!!) M3S${spindle}
G43${correctionH}Z100.
Z${safeZ}.M8
G98G81Z${depth}.R10.F${feed}

`;
                
                // æ·»åŠ æ‰€æœ‰åº§æ¨™é»
                coords.forEach((coord, index) => {
                    code += `X${coord.x.toFixed(3)}Y${coord.y.toFixed(3)}(${index + 1})\n`;
                });
                
                code += `
G0G90Z100.M9
M5


`;
            });
            
            // å°‡åˆ€å…·ä¿¡æ¯æ·»åŠ åˆ°ä»£ç¢¼é–‹é ­
            code = `${toolInfo}\n${code}`;
            
            // æœ€å¾Œè¿½åŠ çµå°¾ç¨‹å¼ç¢¼
            code += `
(~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~)
${programEndX}
M30
`;
            
            // é¡¯ç¤ºçµæœ
            const resultElement = document.getElementById('gcodeOutput');
            resultElement.innerHTML = code;
            updateImportStatus('âœ… G-CODEç”Ÿæˆå®Œæˆ', 'success');
            
            // æ»¾å‹•åˆ°è¼¸å‡ºçµæœå€åŸŸ
            setTimeout(() => {
                resultElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }



        // è¤‡è£½G-CODE
        function copyGCode() {
            const resultDiv = document.getElementById('gcodeOutput');
            const textToCopy = resultDiv.innerText || resultDiv.textContent;
            
            if (textToCopy === 'ç­‰å¾…ç”ŸæˆG-CODE...' || textToCopy.trim() === '') {
                updateImportStatus('âŒ è«‹å…ˆç”ŸæˆG-CODE', 'error');
                return;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                updateImportStatus('âœ… G-CODEå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }).catch(() => {
                updateImportStatus('âŒ è¤‡è£½å¤±æ•—', 'error');
            });
        }

        // å„²å­˜G-CODEæª”æ¡ˆ
        function saveGCode() {
            const resultDiv = document.getElementById('gcodeOutput');
            const code = resultDiv.innerText || resultDiv.textContent;
            
            if (code === 'ç­‰å¾…ç”ŸæˆG-CODE...' || code.trim() === '') {
                updateImportStatus('âŒ è«‹å…ˆç”ŸæˆG-CODE', 'error');
                return;
            }
            
            // å¾å‹è™Ÿæ¬„ä½è‡ªå‹•æŠ“å–è³‡æ–™ï¼Œä¸¦æ¸…ç†æª”å
            const modelInput = document.getElementById('model').value;
            let modelName = modelInput ? modelInput.trim() : '';
            
            // å¦‚æœå‹è™Ÿæ¬„ä½ç‚ºç©ºï¼Œä½¿ç”¨é è¨­åç¨±
            if (!modelName) {
                modelName = 'CNC_Program';
            }
            
            // æ¸…ç†æª”åä¸­çš„ç„¡æ•ˆå­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯ã€æ•¸å­—ã€åº•ç·šå’ŒçŸ­æ©«ç·š
            modelName = modelName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5_-]/g, '_');
            
            // ç”Ÿæˆæ™‚é–“æˆ³
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
            const timeStr = now.toTimeString().slice(0, 5).replace(':', ''); // HHMM
            
            // çµ„åˆæª”åï¼šå‹è™Ÿ_drilling_æ—¥æœŸ_æ™‚é–“.txt
            const filename = `${modelName}_drilling_${dateStr}_${timeStr}.txt`;
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateImportStatus(`âœ… æª”æ¡ˆå·²å„²å­˜ç‚º: ${filename}`, 'success');
        }

        // è¼‰å…¥ç¯„ä¾‹æ•¸æ“šï¼ˆå¢å¼·ç‰ˆï¼‰
        function loadSampleData() {
            const sampleData = `Xåº§æ¨™\tYåº§æ¨™\tåœ“å¤§å°
72\t-44.37\t10
332\t150\t10
632\t-44.37\t6
100.5\t200.75\t25
150.25\t300\t30.5
50\t100\t3
75\t125\t3
200\t250\t12
225\t275\t12
300\t350\t4`;
            
            document.getElementById('inputData').value = sampleData;
            updateImportStatus('âœ… å·²è¼‰å…¥ç¯„ä¾‹æ•¸æ“š', 'success');
            convertAndProcessData();
        }

        // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
        function clearCoordinates() {
            coordinateData = [];
            processedCoordinates = {};
            document.getElementById('inputData').value = '';
            document.getElementById('coordinatePreview').innerHTML = '<div style="text-align: center; color: #999;">å°šæœªå°å…¥åº§æ¨™æ•¸æ“š</div>';
            document.getElementById('coordinateStats').style.display = 'none';
            document.getElementById('gcodeOutput').textContent = 'ç­‰å¾…ç”ŸæˆG-CODE...';
            updateImportStatus('ğŸ”„ å·²æ¸…é™¤æ‰€æœ‰æ•¸æ“š', 'info');
        }

        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateImportStatus(message, type = 'info') {
            const statusEl = document.getElementById('importStatus');
            statusEl.textContent = message;
            
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#8B4513'
            };
            
            statusEl.style.color = colors[type] || colors.info;
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥URLåƒæ•¸
        window.addEventListener('load', function() {
            checkURLParams();
            if (!window.location.search.includes('data=')) {
                updateImportStatus('ç³»çµ±å°±ç·’ï¼Œç­‰å¾…CADæ•¸æ“šå°å…¥...', 'info');
            }
        });

        // åº§æ¨™å°æ¥åˆ°ç¨‹å¼æ®µåŠŸèƒ½
        function mapCoordinatesToProgram(diameter) {
            try {
                // ç²å–é¸æ“‡çš„ç¨‹å¼æ®µ
                const programSelect = document.getElementById(`programSelect-${diameter}`);
                const selectedProgram = programSelect.value;
                
                if (!selectedProgram) {
                    updateImportStatus('âŒ è«‹å…ˆé¸æ“‡è¦å°æ¥çš„ç¨‹å¼æ®µ', 'error');
                    return;
                }
                
                // æª¢æŸ¥è©²ç›´å¾‘çš„åº§æ¨™æ•¸æ“šæ˜¯å¦å­˜åœ¨
                if (!processedCoordinates[diameter] || processedCoordinates[diameter].length === 0) {
                    updateImportStatus('âŒ è©²ç›´å¾‘æ²’æœ‰åº§æ¨™æ•¸æ“š', 'error');
                    return;
                }
                
                const coords = processedCoordinates[diameter];
                
                // æª¢æŸ¥ç¨‹å¼æ®µæ˜¯å¦å·²ç¶“æ¿€æ´»ï¼Œå¦‚æœæ²’æœ‰å‰‡è‡ªå‹•æ¿€æ´»
                const programCheckbox = document.getElementById(selectedProgram);
                if (!programCheckbox.checked) {
                    programCheckbox.checked = true;
                    // è§¸ç™¼ç¨‹å¼æ®µå‰µå»º
                    toggleProgramSection(selectedProgram);
                    
                    // ç­‰å¾…ä¸€å°æ®µæ™‚é–“è®“DOMæ›´æ–°
                    setTimeout(() => {
                        fillProgramData(selectedProgram, diameter, coords);
                    }, 100);
                } else {
                    fillProgramData(selectedProgram, diameter, coords);
                }
                
            } catch (error) {
                console.error('åº§æ¨™å°æ¥éŒ¯èª¤:', error);
                updateImportStatus(`âŒ åº§æ¨™å°æ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // å¡«å……ç¨‹å¼æ®µæ•¸æ“š
        function fillProgramData(programNumber, diameter, coords) {
            try {
                // ç¢ºä¿ç¨‹å¼æ®µè¡¨å–®å­˜åœ¨
                const fieldset = document.getElementById(`fieldset_${programNumber}`);
                if (!fieldset) {
                    updateImportStatus('âŒ ç¨‹å¼æ®µè¡¨å–®æœªæ‰¾åˆ°ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                    return;
                }
                
                // ç”Ÿæˆç¬¬ä¸€åº§æ¨™æ ¼å¼ (ç¬¬ä¸€è¡Œåº§æ¨™)
                const firstCoord = coords[0];
                const firstCoordinateText = `X${firstCoord.x.toFixed(2)} Y${firstCoord.y.toFixed(2)} (${firstCoord.diameter.toFixed(1)})`;
                
                // ç”Ÿæˆåº§æ¨™å€‘æ ¼å¼ (é™¤äº†ç¬¬ä¸€è¡Œä¹‹å¤–çš„å…¶ä»–åº§æ¨™)
                let coordinatesText = '';
                if (coords.length > 1) {
                    // å¾ç¬¬äºŒå€‹åº§æ¨™é–‹å§‹è™•ç†
                    for (let i = 1; i < coords.length; i++) {
                        const coord = coords[i];
                        const x = coord.x.toFixed(2);
                        const y = coord.y.toFixed(2);
                        const dia = coord.diameter.toFixed(1);
                        coordinatesText += `X${x} Y${y} (${dia})`;
                        if (i < coords.length - 1) {
                            coordinatesText += '\n';
                        }
                    }
                }
                // å¦‚æœåªæœ‰ä¸€å€‹åº§æ¨™ï¼ŒcoordinatesText ä¿æŒç©ºå­—ä¸²
                
                // å¡«å…¥ç¬¬ä¸€åº§æ¨™
                const coordinateXYField = document.getElementById(`coordinateXY-${programNumber}`);
                if (coordinateXYField) {
                    coordinateXYField.value = firstCoordinateText;
                }
                
                // å¡«å…¥åº§æ¨™å€‘
                const coordinatesField = document.getElementById(`coordinates-${programNumber}`);
                if (coordinatesField) {
                    coordinatesField.value = coordinatesText;
                }
                
                // è‡ªå‹•å¡«å…¥ç›¸é—œçš„ç›´å¾‘è³‡è¨Šåˆ°åˆ€åº«å‚™è¨»ï¼ˆå¦‚æœæœ‰åŒ¹é…çš„é¸é …ï¼‰
                const toolRemarkField = document.getElementById(`toolRemark-${programNumber}`);
                if (toolRemarkField) {
                    // å˜—è©¦åŒ¹é…ç›´å¾‘åˆ°é‘½é ­é¡å‹
                    const diameterInt = Math.round(diameter);
                    const possibleToolTypes = [
                        `${diameterInt}mm drill`,
                        `${diameter.toFixed(0)}mm drill`
                    ];
                    
                    for (let toolType of possibleToolTypes) {
                        const option = Array.from(toolRemarkField.options).find(opt => opt.value === toolType);
                        if (option) {
                            toolRemarkField.value = toolType;
                            // è§¸ç™¼åƒæ•¸æ›´æ–°
                            updateToolParameters(programNumber);
                            break;
                        }
                    }
                }
                
                updateImportStatus(`âœ… å·²æˆåŠŸå°æ¥ç›´å¾‘ ${diameter.toFixed(1)}mm (${coords.length} é») åˆ° ${programNumber}`, 'success');
                
                // æ»¾å‹•åˆ°å°æ‡‰çš„ç¨‹å¼æ®µåˆ€åº«Tä½ç½®
                setTimeout(() => {
                    // å°è¯•æ»šåŠ¨åˆ°åˆ€åº«Tå­—æ®µä½ç½®
                    const toolTField = document.getElementById(`toolT-${programNumber}`);
                    if (toolTField) {
                        // æ‰¾åˆ°åŒ…å«åˆ€åº«Tå­—æ®µçš„form-group
                        const formGroup = toolTField.closest('.form-group');
                        if (formGroup) {
                            formGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            toolTField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    } else {
                        // å¦‚æœåˆ€åº«Tå­—æ®µé‚„æ²’å‰µå»ºï¼Œæ»¾å‹•åˆ°ç¨‹å¼æ®µè¡¨å–®é ‚éƒ¨
                        const fieldset = document.getElementById(`fieldset_${programNumber}`);
                        if (fieldset) {
                            fieldset.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            // å¦‚æœç¨‹å¼æ®µè¡¨å–®ä¹Ÿé‚„æ²’å‰µå»ºï¼Œæ»¾å‹•åˆ°å°æ‡‰çš„checkbox
                            const programCheckbox = document.getElementById(programNumber);
                            if (programCheckbox) {
                                const checkboxItem = programCheckbox.closest('.checkbox-item');
                                if (checkboxItem) {
                                    checkboxItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }
                        }
                    }
                }, 300);
                
            } catch (error) {
                console.error('å¡«å……ç¨‹å¼æ®µæ•¸æ“šéŒ¯èª¤:', error);
                updateImportStatus(`âŒ å¡«å……æ•¸æ“šå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ç›£è½PostMessage
        window.addEventListener('message', function(event) {
            try {
                if (event.data && event.data.coordinates) {
                    processCADData(event.data);
                    updateImportStatus('âœ… å·²æ¥æ”¶è·¨çª—å£CADæ•¸æ“š', 'success');
                }
            } catch (e) {
                updateImportStatus('âŒ PostMessageæ•¸æ“šè™•ç†å¤±æ•—: ' + e.message, 'error');
            }
        });
    </script>
</body>
</html>